-- TRSDB.V_TRS_FACT_CFC_TAX_INCOME source

CREATE OR REPLACE FORCE EDITIONABLE VIEW "TRSDB"."V_TRS_FACT_CFC_TAX_INCOME" ("ENTITY_CODE", "INV_ENTITY_CODE", "PERIOD", "SCENARIO", "SUB_OPE_EXEMPTION", "COUNTRY_ID", "LOCAL_CURRENCY_ID", "ACCUMULATED_AMOUNT", "AMOUNT_TOTAL", "REALIZED_LOSS", "DISTRI_NONCN", "DISTRI_CN", "DESPITE_PROFIT", "FVPL_APP", "FVPL_FVCHANGE", "FVPL_AMOUNT", "RE_FVPL_AMOUNT", "NON_CFC_DISPOSAL_ADJ", "CFC_EARNINGS", "AVG_RATIO_HOLD") AS 
  WITH CTE0 AS (
SELECT
	t1.PERIOD,
	t1.ENTITY_CODE,
	t1.SCENARIO
FROM V_TRS_FACT_CFC_ENTITY_VERSION t1
JOIN TRS_DIM_ENTITY t2 ON t1.ENTITY_CODE = t2.ENTITY_CODE AND T2.COUNTRY_ID != 'TW'
),CTE_REC_AMT_TOTAL AS (
SELECT
	T1.PERIOD ,
	T1.SCENARIO ,
	T2.CURRENT_CODE AS CFC_ENTITY_CODE,
	T1.TAX_REV_TOTAL,
	T1.TAX_EXP_TOTAL,
	T1.RE_ADD_TOTAL,
	T1.RE_LESS_TOTAL
FROM TRS_FACT_CFC_INV_RECOGNIZED_AMOUNT_TOTAL T1
LEFT JOIN V_TRS_DIM_ENTITY_CUR T2 ON T1.CFC_ENTITY_CODE = T2.ENTITY_CODE 
)
,CTE AS (
SELECT
	t1.PERIOD,
	t1.SCENARIO,
	t1.BASE_ENTITY AS CFC_ENTITY_CODE,
	SUM(TRUNC(t1.AMOUNT * t1.AVG_EXCHANGE_RATIO * t1.RATIO, 0)) + SUM(TRUNC(NVL(t1.RE_AMOUNT, 0) * t1.AVG_EXCHANGE_RATIO * t1.RATIO, 0)) AS AMOUNT_NTD,
	SUM(TRUNC(t1.CFC_TAX * t1.CFC_EXCHANGE_RATIO, 0)) AS CFC_TAX_NTD,
	TRUNC(t2.TAX_REV_TOTAL * t1.CFC_EXCHANGE_RATIO, 0) AS TAX_REV_TOTAL,
	TRUNC(t2.TAX_EXP_TOTAL * t1.CFC_EXCHANGE_RATIO, 0)AS TAX_EXP_TOTAL
FROM V_TRS_FACT_CFC_INV_RECOGNIZED_AMOUNT_DETAIL t1
LEFT JOIN CTE_REC_AMT_TOTAL t2 ON t1.PERIOD = t2.PERIOD AND t1.BASE_ENTITY = t2.CFC_ENTITY_CODE AND t1.SCENARIO = t2.SCENARIO
WHERE t1.AMOUNT IS NOT NULL AND IS_LOWTAX = 'false'
GROUP BY t1.PERIOD, t1.SCENARIO, t1.BASE_ENTITY, TAX_REV_TOTAL, (t2.TAX_REV_TOTAL * t1.CFC_EXCHANGE_RATIO), (t2.TAX_EXP_TOTAL * t1.CFC_EXCHANGE_RATIO)
), CTE2 AS (
SELECT
	t1.PERIOD,
	t1.SCENARIO,
	t1.CFC_ENTITY_CODE,
	(NVL(AMOUNT_NTD, 0) + CASE WHEN TAX_REV_TOTAL IS NOT NULL OR TAX_EXP_TOTAL IS NOT NULL THEN NVL(TAX_REV_TOTAL, 0) + NVL(TAX_EXP_TOTAL, 0) ELSE NVL(CFC_TAX_NTD, 0) END) AS AMOUNT_TOTAL
FROM CTE t1
)
,CTE3 AS (
--自”獲配股利及實際虧損”頁面取數，加總非低稅區國家項目、金額為負之”CFC實際獲配/實際虧損金額”之金額並乘以-1
	SELECT 
		t1.PERIOD,
		t1.SCENARIO,
		t1.CFC_ENTITY_CODE,
		SUM(t1.REALIZED_LOSS_NTD) AS REALIZED_LOSS
	FROM V_TRS_FACT_CFC_REALIZED_LOSS t1
	GROUP BY t1.PERIOD, t1.SCENARIO, t1.CFC_ENTITY_CODE
),CTE_INV_DIVIDEND AS (
SELECT
	t1.PERIOD,
	t1.SCENARIO,
	t1.CFC_ENTITY_CODE,
	t1.AMOUNT_TOTAL AS AMOUNT,
	t1.RATIO_HOLD,
	t1.AVG_EXCHANGE_RATIO,
	NVL(t1.TAX_CREDIT_TOTAL, 0)AS DEDUCTABLE_TAX,
	t1.IS_LOWTAX,
	t1.COUNTRY_ID,
	t1.DECLARATION_DATE,
	t1.FISCAL_YEAR
FROM V_TRS_FACT_CFC_INV_DIVIDEND t1
WHERE AMOUNT_TOTAL > 0
	AND IS_LOWTAX = 'false' --FALSE
	AND (DECLARATION_DATE >= TO_DATE('2024-04-01', 'YYYY-MM-DD') OR FISCAL_YEAR >= 2023)
)
,CTE4 AS (
--自”獲配股利及實際虧損”頁面取數，加總非低稅區國家項目且非中國大陸、金額為正之”CFC實際獲配/實際虧損金額減除可扣抵稅額”之金額
	SELECT
		t1.PERIOD,
		t1.SCENARIO,
		t1.CFC_ENTITY_CODE,
		TRUNC(SUM(t1.AMOUNT - DEDUCTABLE_TAX), 5) AS DISTRI_NONCN
	FROM CTE_INV_DIVIDEND t1
	WHERE COUNTRY_ID != 'CN'
	GROUP BY t1.PERIOD, t1.SCENARIO, t1.CFC_ENTITY_CODE
)
,CTE5 AS (
--盈餘分配數
--自”獲配股利及實際虧損”頁面取數，加總非低稅區國家項目且為中國大陸、金額為正之”CFC實際獲配/實際虧損金額”之金額
	SELECT
		t1.PERIOD,
		t1.SCENARIO,
		t1.CFC_ENTITY_CODE,
		TRUNC(SUM(t1.AMOUNT), 5) AS DISTRI_CN
	FROM CTE_INV_DIVIDEND t1
	WHERE COUNTRY_ID = 'CN'
	GROUP BY t1.PERIOD, t1.SCENARIO, t1.CFC_ENTITY_CODE
),CTE8 AS (
--稅後淨利
--依篩選項加總TB數據，將4、5、6、7開頭科目加總
	SELECT
		T1.CURRENT_CODE AS ENTITY_CODE,
		T1.SCENARIO,
		--有些月份是06有些是6，統一格式
		T1.PERIOD || '-' || LPAD(T1.MONTH, 2, 0)  AS PERIOD,
		TRUNC(SUM(T1.ACCUMULATED_AMOUNT_ORI * -1 * T3.AVG_EXCHANGE_RATIO), 0)AS ACCUMULATED_AMOUNT 
	FROM MV_TRS_TB_ACTUAL_ACCOUNT_AMOUNT T1
	JOIN TRS_DIM_ENTITY t2 ON t1.ENTITY_CODE = t2.ENTITY_CODE AND T2.COUNTRY_ID != 'TW'
	LEFT JOIN V_TRS_FACT_EXCHANGE_BANKOFTW T3 ON (T1.PERIOD || '-' || LPAD(T1.MONTH,2,0)) = T3.PERIOD AND T1.CURRENCY_CODE = T3.CURRENCY_ID AND TARGET_CURRENCY_ID = 'NTD' AND T1.SCENARIO = T3.SCENARIO 
	WHERE SUBSTR(T2_CODE, 0, 1) BETWEEN '4' AND '7' 
	GROUP BY T1.CURRENT_CODE, T1.SCENARIO, T1.PERIOD || '-' || LPAD(T1.MONTH,2,0)
)
,CTE_NONLOW AS (
	SELECT
		PERIOD,
		SCENARIO,
		CFC_ENTITY_CODE,
		SUM(DISPOSE_ADJ_NTD + NVL(INCOME_TAX_NTD, 0)) AS NON_CFC_DISPOSAL_ADJ
	FROM V_TRS_FACT_CFC_NONLOW_ADJ
	GROUP BY CFC_ENTITY_CODE, SCENARIO, PERIOD
),CTE_RATIO_HOLD AS (
	SELECT
		ENTITY_CODE,
		PERIOD,
		INV_ENTITY_CODE,
		TRUNC(SUM(AVG_RATIO_HOLD), 4) AS AVG_RATIO_HOLD
	FROM V_TRS_FACT_CFC_RATIO_HOLD
	GROUP BY ENTITY_CODE, PERIOD, INV_ENTITY_CODE
),CTE9 AS (
SELECT
	TRUNC(CTE0.PERIOD, 'DD') AS PERIOD,
	CTE0.SCENARIO,
	CTE0.ENTITY_CODE AS CFC_ENTITY_CODE,
	CTE8.ACCUMULATED_AMOUNT,
	CTE2.AMOUNT_TOTAL,
	CTE3.REALIZED_LOSS,
	CTE4.DISTRI_NONCN,
	CTE5.DISTRI_CN,
	CTE_NONLOW.NON_CFC_DISPOSAL_ADJ
FROM CTE0
LEFT JOIN CTE2 ON CTE0.PERIOD = CTE2.PERIOD AND CTE0.SCENARIO = CTE2.SCENARIO AND CTE0.ENTITY_CODE = CTE2.CFC_ENTITY_CODE
LEFT JOIN CTE3 ON CTE0.SCENARIO = CTE3.SCENARIO AND CTE0.PERIOD = CTE3.PERIOD AND CTE0.ENTITY_CODE = CTE3.CFC_ENTITY_CODE 
LEFT JOIN CTE4 ON CTE0.SCENARIO = CTE4.SCENARIO AND CTE4.PERIOD = CTE0.PERIOD AND CTE0.ENTITY_CODE = CTE4.CFC_ENTITY_CODE 
LEFT JOIN CTE5 ON CTE0.SCENARIO = CTE5.SCENARIO AND CTE5.PERIOD = CTE0.PERIOD AND CTE0.ENTITY_CODE = CTE5.CFC_ENTITY_CODE 
LEFT JOIN CTE8 ON CTE8.PERIOD = TO_CHAR(CTE0.PERIOD, 'YYYY-MM') AND CTE0.SCENARIO = CTE8.SCENARIO AND CTE0.ENTITY_CODE = CTE8.ENTITY_CODE
LEFT JOIN CTE_NONLOW ON CTE0.PERIOD = CTE_NONLOW.PERIOD AND CTE0.SCENARIO = CTE_NONLOW.SCENARIO AND CTE0.ENTITY_CODE = CTE_NONLOW.CFC_ENTITY_CODE
),CTE_EXEMPTION AS (
SELECT
	t1.ENTITY_CODE,
	t1.INV_ENTITY_CODE,
	t1.PERIOD,
	t1.SCENARIO,
	t1.SUB_OPE_EXEMPTION,
	t1.COUNTRY_ID,
	t1.LOCAL_CURRENCY_ID
FROM V_TRS_FACT_CFC_EXEMPTION t1
WHERE t1.IS_CFC = 'true'
),CTE_OTHER_AMOUNT AS (
SELECT
	T1.PERIOD ,
	T2.CURRENT_CODE AS INV_ENTITY_CODE,
	T1.SCENARIO ,
	T1.DESPITE_PROFIT,
	T1.FVPL_AMOUNT,
	T1.FVPL_FVCHANGE,
	T1.RE_FVPL_AMOUNT
FROM V_TRS_FACT_CFC_OTHER_AMOUNT T1
LEFT JOIN V_TRS_DIM_ENTITY_CUR T2 ON T1.INV_ENTITY_CODE = T2.ENTITY_CODE 
),CTE_FVPL AS (
SELECT
	T1.PERIOD ,
	T1.FVPL_APP,
	T2.CURRENT_CODE AS ENTITY_CODE 
FROM TRS_FACT_FVPL_EXEMPTION T1
LEFT JOIN V_TRS_DIM_ENTITY_CUR T2 ON T1.ENTITY_CODE = T2.ENTITY_CODE 
)
SELECT
	t1.ENTITY_CODE,
	t1.INV_ENTITY_CODE,
	t1.PERIOD,
	t1.SCENARIO,
	t1.SUB_OPE_EXEMPTION,
	t1.COUNTRY_ID,
	t1.LOCAL_CURRENCY_ID,
	CTE9.ACCUMULATED_AMOUNT,
	CTE9.AMOUNT_TOTAL,
	CTE9.REALIZED_LOSS,
	CTE9.DISTRI_NONCN,
	CTE9.DISTRI_CN,
	t2.DESPITE_PROFIT,
	t4.FVPL_APP,
	CASE WHEN t4.FVPL_APP != 'Y' THEN 0 ELSE t2.FVPL_FVCHANGE END AS FVPL_FVCHANGE,
	CASE WHEN t4.FVPL_APP != 'Y' THEN 0 ELSE t2.FVPL_AMOUNT END AS FVPL_AMOUNT,
	CASE WHEN t4.FVPL_APP != 'Y' THEN 0 ELSE t2.RE_FVPL_AMOUNT END AS RE_FVPL_AMOUNT,
	CTE9.NON_CFC_DISPOSAL_ADJ,
	TRUNC(NVL(CTE9.ACCUMULATED_AMOUNT, 0) - NVL(CTE9.AMOUNT_TOTAL, 0) + NVL(t2.DESPITE_PROFIT, 0) -
	NVL(CTE9.REALIZED_LOSS, 0) + NVL(CTE9.DISTRI_NONCN, 0) + NVL(CTE9.DISTRI_CN, 0) - NVL(CASE WHEN t4.FVPL_APP != 'Y' THEN 0 ELSE t2.FVPL_FVCHANGE END, 0) + NVL(CASE WHEN t4.FVPL_APP != 'Y' THEN 0 ELSE t2.RE_FVPL_AMOUNT END, 0) + NVL(CASE WHEN t4.FVPL_APP != 'Y' THEN 0 ELSE t2.FVPL_AMOUNT END, 0) + NVL(CTE9.NON_CFC_DISPOSAL_ADJ, 0), 0) AS CFC_EARNINGS
	,t3.AVG_RATIO_HOLD
FROM CTE_EXEMPTION t1
LEFT JOIN CTE9 ON t1.INV_ENTITY_CODE = CTE9.CFC_ENTITY_CODE AND CTE9.PERIOD = TRUNC(t1.PERIOD, 'DD') AND t1.SCENARIO = CTE9.SCENARIO
LEFT JOIN CTE_OTHER_AMOUNT t2 ON t1.PERIOD = t2.PERIOD AND t1.INV_ENTITY_CODE = t2.INV_ENTITY_CODE AND t1.SCENARIO = t2.SCENARIO
LEFT JOIN CTE_RATIO_HOLD t3 ON t1.ENTITY_CODE = t3.ENTITY_CODE AND t1.PERIOD = t3.PERIOD AND t1.INV_ENTITY_CODE = t3.INV_ENTITY_CODE
LEFT JOIN CTE_FVPL t4 ON t4.PERIOD = TO_CHAR(t1.PERIOD, 'YYYY-MM') AND t1.ENTITY_CODE = t4.ENTITY_CODE
;