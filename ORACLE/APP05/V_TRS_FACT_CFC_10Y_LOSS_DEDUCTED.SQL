-- TRSDB.V_TRS_FACT_CFC_10Y_LOSS_DEDUCTED source

CREATE OR REPLACE FORCE EDITIONABLE VIEW "TRSDB"."V_TRS_FACT_CFC_10Y_LOSS_DEDUCTED" ("PERIOD", "YYYY", "SCENARIO", "ENTITY_CODE", "CFC_ENTITY_CODE", "EARNINGS_TAX", "LOSS_TAX", "EARNINGS_ASSESSMENT", "LOSS_ASSESSMENT", "APPROVAL") AS 
  WITH CTE_INCOME AS(
 SELECT 
	t1.PERIOD,
	t1.SCENARIO,
	t1.ENTITY_CODE,
	t1.INV_ENTITY_CODE AS CFC_ENTITY_CODE,
	CASE WHEN t1.CFC_EARNINGS >= 0 THEN t1.CFC_EARNINGS ELSE NULL END AS EARNINGS_TAX,
	CASE WHEN t1.CFC_EARNINGS < 0 THEN t1.CFC_EARNINGS * -1 ELSE NULL END AS LOSS_TAX,
	CASE WHEN GAIN_LOSS = 'EARN' THEN t2.AMOUNT ELSE NULL END AS EARNINGS_ASSESSMENT,
	CASE WHEN GAIN_LOSS = 'LOSS' THEN t2.AMOUNT ELSE NULL END AS LOSS_ASSESSMENT,
	t3.APPROVAL
FROM V_TRS_FACT_CFC_TAX_INCOME t1 --申報數
LEFT JOIN V_TRS_FACT_CFC_APPROVAL_DETAIL t2 ON TO_CHAR(t1.PERIOD, 'YYYY') = t2.YEAR AND t1.SCENARIO = t2.SCENARIO AND t1.ENTITY_CODE = t2.ENTITY_CODE AND t1.INV_ENTITY_CODE = t2.INV_ENTITY_CODE
LEFT JOIN V_TRS_FACT_CFC_APPROVAL t3 ON TO_CHAR(t1.PERIOD, 'YYYY-MM-DD') = (t3.YEAR || '-12-31') AND t1.ENTITY_CODE = t3.ENTITY_CODE AND t1.SCENARIO = t3.SCENARIO
)
,CTE_PERIOD AS(
SELECT DISTINCT 
	PERIOD
FROM TRS_FACT_CFC_ENTITY_VERSION
WHERE TO_CHAR(PERIOD, 'YYYY') >= '2023'
),CTE_VERSION AS (
SELECT DISTINCT 
	SCENARIO
FROM TRS_FACT_CFC_ENTITY_VERSION
),CTE_HEAD AS (
SELECT DISTINCT
	PERIOD,
	SCENARIO
FROM TRS_FACT_CFC_ENTITY_VERSION
),CTE0 AS (
SELECT
	t1.PERIOD,
	t2.SCENARIO,
	t1.ENTITY_CODE,
	CFC_ENTITY_CODE,
	EARNINGS_TAX,
	LOSS_TAX,
	EARNINGS_ASSESSMENT,
	LOSS_ASSESSMENT,
	APPROVAL
FROM CTE_INCOME t1
CROSS JOIN CTE_VERSION t2
WHERE t1.SCENARIO = 'Per Audit' AND TO_CHAR(t1.PERIOD, 'MM-DD') = '12-31'
)
SELECT
	t1.PERIOD,
	t2.PERIOD AS YYYY,
	t1.SCENARIO,
	t2.ENTITY_CODE,
	CFC_ENTITY_CODE,
	EARNINGS_TAX,
	LOSS_TAX,
	EARNINGS_ASSESSMENT,
	LOSS_ASSESSMENT,
	APPROVAL
FROM CTE_HEAD t1
JOIN CTE0 t2 ON t1.PERIOD > t2.PERIOD AND t1.SCENARIO  = t2.SCENARIO
UNION ALL
SELECT 
t1.PERIOD,
t2.PERIOD AS YYYY,
t2.SCENARIO,
t2.ENTITY_CODE,
CFC_ENTITY_CODE,
EARNINGS_TAX,
LOSS_TAX,
EARNINGS_ASSESSMENT,
LOSS_ASSESSMENT,
APPROVAL
FROM CTE_PERIOD t1
JOIN CTE_INCOME t2 ON t1.PERIOD = t2.PERIOD;