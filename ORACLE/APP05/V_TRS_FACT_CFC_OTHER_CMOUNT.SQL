-- TRSDB.V_TRS_FACT_CFC_OTHER_AMOUNT source

CREATE OR REPLACE FORCE EDITIONABLE VIEW "TRSDB"."V_TRS_FACT_CFC_OTHER_AMOUNT" ("ID", "PERIOD", "INV_ENTITY_CODE", "SCENARIO", "CURRENCY_CODE", "AVG_EXCHANGE_RATIO", "DESPITE_PROFIT_ORI", "FVPL_AMOUNT_ORI", "FVPL_FVCHANGE_ORI", "RE_FVPL_AMOUNT_ORI", "DESPITE_PROFIT", "FVPL_AMOUNT", "FVPL_FVCHANGE", "RE_FVPL_AMOUNT", "CREATED_TIME", "CREATED_BY") AS 
  WITH CTE AS (
SELECT DISTINCT
	T1.PERIOD|| '-'|| lpad(t1.MONTH, 2,0) AS PERIOD1,
	T1.ENTITY_CODE,
	T1.SCENARIO,
	T1.CURRENCY_CODE,
	T2.AVG_EXCHANGE_RATIO
FROM TRS_FACT_TRIAL_BALANCE T1
LEFT JOIN V_TRS_FACT_EXCHANGE_BANKOFTW T2 ON T1.PERIOD|| '-'||lpad(t1.MONTH, 2,0) = T2.PERIOD AND T1.CURRENCY_CODE = T2.CURRENCY_ID  AND T2.TARGET_CURRENCY_ID = 'NTD' AND T1.SCENARIO = T2.SCENARIO 
)
SELECT
	T1.ID,
	T1.PERIOD,
	T1.INV_ENTITY_CODE,
	T1.SCENARIO,
	T2.CURRENCY_CODE,
	T2.AVG_EXCHANGE_RATIO,
	T1.DESPITE_PROFIT AS DESPITE_PROFIT_ORI,
	T1.FVPL_AMOUNT AS FVPL_AMOUNT_ORI,
	T1.FVPL_FVCHANGE AS FVPL_FVCHANGE_ORI,
	T1.RE_FVPL_AMOUNT AS RE_FVPL_AMOUNT_ORI,
	T1.DESPITE_PROFIT * AVG_EXCHANGE_RATIO AS DESPITE_PROFIT,
	T1.FVPL_AMOUNT * AVG_EXCHANGE_RATIO AS FVPL_AMOUNT,
	T1.FVPL_FVCHANGE * AVG_EXCHANGE_RATIO AS FVPL_FVCHANGE,
	T1.RE_FVPL_AMOUNT * AVG_EXCHANGE_RATIO AS RE_FVPL_AMOUNT,
	T1.CREATED_TIME,
	T1.CREATED_BY
FROM TRS_FACT_CFC_OTHER_AMOUNT T1
LEFT JOIN CTE T2 ON TO_CHAR(T1.PERIOD, 'YYYY-MM') = T2.PERIOD1 AND T1.INV_ENTITY_CODE = T2.ENTITY_CODE AND T1.SCENARIO = T2.SCENARIO;