-- TRSDB.V_TRS_CFC_10Y_DEDUCTION_RESULT source

CREATE OR REPLACE FORCE EDITIONABLE VIEW "TRSDB"."V_TRS_CFC_10Y_DEDUCTION_RESULT" ("PERIOD", "YYYY", "SCENARIO", "ENTITY_CODE", "CFC_ENTITY_CODE", "EARNINGS_TAX", "LOSS_TAX", "EARNINGS_ASSESSMENT", "LOSS_ASSESSMENT", "APPROVAL", "CATEGORY", "PAST_DEDUCTION", "THIS_DEDUCTION") AS 
  WITH CTE_PAST AS (
SELECT
	SUM(DEDUCTION) AS PAST_DEDUCTION,
	SCENARIO,
	ENTITY_CODE,
	CFC_ENTITY_CODE,
	PERIOD,
	FISCAL_YEAR,
	CATEGORY
FROM V_TRS_CFC_10Y_DEDUCTION_DETAIL
WHERE TO_CHAR(PERIOD, 'YYYY') > TO_CHAR(DEDUCTED_YEAR, 'YYYY')
GROUP BY PERIOD, SCENARIO, ENTITY_CODE, CFC_ENTITY_CODE, FISCAL_YEAR, CATEGORY
),CTE_THIS_YEAR AS(
SELECT
	SUM(DEDUCTION) AS THIS_DEDUCTION,
	SCENARIO,
	ENTITY_CODE,
	CFC_ENTITY_CODE,
	PERIOD,
	FISCAL_YEAR,
	CATEGORY
FROM V_TRS_CFC_10Y_DEDUCTION_DETAIL
WHERE TO_CHAR(PERIOD, 'YYYY') = TO_CHAR(DEDUCTED_YEAR, 'YYYY')
GROUP BY PERIOD, SCENARIO, ENTITY_CODE, CFC_ENTITY_CODE, FISCAL_YEAR, CATEGORY
)
SELECT
	t1."PERIOD",
	t1."YYYY",
	t1."SCENARIO",
	t1."ENTITY_CODE",
	t1."CFC_ENTITY_CODE",
	t1."EARNINGS_TAX",
	t1."LOSS_TAX",
	t1."EARNINGS_ASSESSMENT",
	t1."LOSS_ASSESSMENT",
	t1."APPROVAL",
	CASE WHEN t3.CATEGORY IS NOT NULL THEN t3.CATEGORY ELSE t2.CATEGORY END AS CATEGORY,
	t2.PAST_DEDUCTION,
	t3.THIS_DEDUCTION
FROM V_TRS_FACT_CFC_10Y_LOSS_DEDUCTED t1
LEFT JOIN CTE_PAST t2 ON t1.ENTITY_CODE = t2.ENTITY_CODE AND t1.CFC_ENTITY_CODE = t2.CFC_ENTITY_CODE AND t1.PERIOD = t2.PERIOD AND t1.SCENARIO = t2.SCENARIO AND t1.YYYY = t2.FISCAL_YEAR
LEFT JOIN CTE_THIS_YEAR t3 ON t1.ENTITY_CODE = t3.ENTITY_CODE AND t1.CFC_ENTITY_CODE = t3.CFC_ENTITY_CODE AND t1.PERIOD = t3.PERIOD AND t1.SCENARIO = t3.SCENARIO AND t1.YYYY = t3.FISCAL_YEAR;