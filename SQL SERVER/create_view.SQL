-- dbo.TRS_FACT_GROUP_INV_REL source
CREATE VIEW TRS_FACT_GROUP_INV_REL ("ID", "TYPE", "ENTITY_CODE", "INV_ENTITY_CODE", "INV_ENTITY_CAPITAL", "SHARES_HOLD", "START_DATE", "END_DATE", "RATIO_HOLD", "REVIEWED", "INV_ADJITEM_CODE", "CREATED_BY", "CREATED_TIME", "UPDATED_BY", "UPDATED_TIME") AS 
WITH V1 AS (
SELECT 
ROW_NUMBER()OVER(PARTITION BY ISNULL(t1.CURRENT_CODE, a.ENTITY_CODE )  , ISNULL(t2.CURRENT_CODE,a.INV_ENTITY_CODE) order by START_DATE) AS SEQ,
ID,
TYPE,
ISNULL(t1.CURRENT_CODE, a.ENTITY_CODE ) AS ENTITY_CODE,
ISNULL(t2.CURRENT_CODE,a.INV_ENTITY_CODE) AS INV_ENTITY_CODE,
START_DATE,
REVIEWED,
CREATED_BY,
CREATED_TIME,
UPDATED_BY,
UPDATED_TIME,
INV_ADJITEM_CODE,
SHARES_HOLD,
INV_ENTITY_CAPITAL,
RATIO_HOLD
FROM PRE_TRS_FACT_GROUP_INV_REL a
LEFT JOIN V_TRS_DIM_ENTITY_CUR t1 ON a.ENTITY_CODE = t1.ENTITY_CODE
LEFT JOIN V_TRS_DIM_ENTITY_CUR t2 ON a.INV_ENTITY_CODE = t2.ENTITY_CODE
),v2 AS  (
SELECT
*,
SUM(1)OVER(PARTITION BY ENTITY_CODE  , INV_ENTITY_CODE ) AS CNT,
SUM(1)OVER(PARTITION BY ENTITY_CODE  , INV_ENTITY_CODE order by START_DATE) AS SEQ2
FROM
V1
)
SELECT    
        a.ID,
        a.TYPE,
        a.ENTITY_CODE AS ENTITY_CODE,
        a.INV_ENTITY_CODE AS INV_ENTITY_CODE,
        a.INV_ENTITY_CAPITAL,
        a.SHARES_HOLD, 
        a.START_DATE,
		/*CASE WHEN a.CNT=a.SEQ THEN CAST('2099-12-31T00:00:00' AS DATETIME)
		ELSE DATEADD(DAY, -1, b.START_DATE) END AS END_DATE,*/
		ISNULL(DATEADD(DAY, -1, b.START_DATE),CAST('2099-12-31T00:00:00' AS DATETIME)) AS END_DATE,
        a.RATIO_HOLD,
        a.REVIEWED,
        a.INV_ADJITEM_CODE,
        a.CREATED_BY,
        a.CREATED_TIME,
        a.UPDATED_BY,
        a.UPDATED_TIME
FROM V1 a
LEFT JOIN V1 b ON a.ENTITY_CODE = b.ENTITY_CODE and a.INV_ENTITY_CODE = b.INV_ENTITY_CODE AND a.SEQ = b.SEQ-1;




-- dbo.V_TRS_CFC_10Y_DEDUCTION_DETAIL source

CREATE VIEW V_TRS_CFC_10Y_DEDUCTION_DETAIL AS
WITH CTE3 (ENTITY_CODE, CFC_ENTITY_CODE,PERIOD, SCENARIO, ID, YYYY,AMT,DEDUCTABLE_AMT,ACC_LOSS, CATEGORY) AS(
SELECT
	ENTITY_CODE,
	CFC_ENTITY_CODE,
	PERIOD,
	SCENARIO,
	ID,
	YYYY,
	AMT,
	0 AS DEDUCTABLE_AMT,
	CASE WHEN AMT <0 THEN AMT*-1 ELSE 0 END AS ACC_LOSS,
	CATEGORY
FROM TEMP_TRS_10Y_DEDUCTION_DETAIL
WHERE ID = '1'
UNION ALL
SELECT 
	t1.ENTITY_CODE,
	t1.CFC_ENTITY_CODE,
	t1.PERIOD,
	t1.SCENARIO,
	t1.ID,
	t1.YYYY,
	t1.AMT,
	CASE WHEN t1.AMT >=0 AND t1.AMT<= t2.ACC_LOSS THEN CAST(t1.AMT as int)
	    WHEN t1.AMT >=0 AND t1.AMT > t2.ACC_LOSS THEN cast(t2.ACC_LOSS as int)
	    ELSE 0
	    END AS DEDUCTABLE_AMT,
	CASE WHEN t1.AMT <0 THEN  t1.AMT*-1+t2.ACC_LOSS
        WHEN t1.AMT >=0 AND t1.AMT > t2.ACC_LOSS THEN 0
        WHEN t1.AMT >=0 AND t1.AMT <= t2.ACC_LOSS THEN t2.ACC_LOSS-t1.AMT
        END AS ACC_LOSS
    ,t1.CATEGORY
FROM TEMP_TRS_10Y_DEDUCTION_DETAIL t1
JOIN CTE3 t2 ON t1.ID = t2.ID+1 AND t1.SCENARIO = t2.SCENARIO AND t1.ENTITY_CODE = t2.ENTITY_CODE AND t1.CFC_ENTITY_CODE = t2.CFC_ENTITY_CODE  AND t1.PERIOD = t2.PERIOD
)
,LOSS AS(
SELECT 
	ENTITY_CODE,
	CFC_ENTITY_CODE,
	PERIOD,
	SCENARIO,
	YYYY,
	AMT,
	SUM(AMT*-1) OVER (PARTITION BY PERIOD, ENTITY_CODE, CFC_ENTITY_CODE, SCENARIO ORDER BY YYYY)-AMT*-1 +1 AS STARTS,
	SUM(AMT*-1) OVER (PARTITION BY PERIOD, ENTITY_CODE, CFC_ENTITY_CODE, SCENARIO ORDER BY YYYY) AS ENDS
	,CATEGORY
	FROM CTE3
WHERE AMT<0
)
,PROFIT AS(
	SELECT 
	ENTITY_CODE,
	CFC_ENTITY_CODE,
	PERIOD,
	SCENARIO,
	YYYY,
	AMT,
	SUM(DEDUCTABLE_AMT) OVER (PARTITION BY PERIOD, ENTITY_CODE, CFC_ENTITY_CODE, SCENARIO ORDER BY YYYY)-DEDUCTABLE_AMT +1 AS STARTS,
	SUM(DEDUCTABLE_AMT) OVER (PARTITION BY PERIOD, ENTITY_CODE, CFC_ENTITY_CODE, SCENARIO ORDER BY YYYY) AS ENDS
	,CATEGORY
	FROM CTE3
WHERE DEDUCTABLE_AMT>0
)
SELECT
	P.ENTITY_CODE,
	P.CFC_ENTITY_CODE,
	P.PERIOD,
	P.SCENARIO,
	P.YYYY AS DEDUCTED_YEAR,
	P.AMT AS PROFIT_AMT,
	CASE WHEN L.STARTS <= P.STARTS AND L.ENDS <= P.ENDS THEN L.ENDS-P.STARTS+1
    WHEN L.STARTS <= P.STARTS AND L.ENDS >= P.ENDS THEN P.ENDS-P.STARTS+1
    WHEN L.STARTS >= P.STARTS AND L.ENDS <= P.ENDS THEN L.ENDS-L.STARTS+1
    WHEN L.STARTS >= P.STARTS AND L.ENDS >= P.ENDS THEN P.ENDS-L.STARTS+1
    END AS DEDUCTION,
	L.YYYY AS FISCAL_YEAR,
	L.AMT AS LOSS
	,P.CATEGORY
FROM LOSS L
JOIN PROFIT P ON P.ENTITY_CODE = L.ENTITY_CODE AND P.CFC_ENTITY_CODE = L.CFC_ENTITY_CODE AND P.PERIOD = L.PERIOD AND P.SCENARIO = L.SCENARIO AND NOT ( L.ENDS < P.STARTS OR L.STARTS > P.ENDS);


-- dbo.V_TRS_FACT_CFC_ENTITY_VERSION source

CREATE VIEW V_TRS_FACT_CFC_ENTITY_VERSION AS
  SELECT 
	t1.ID,
	t1.PERIOD,
	--t1.ENTITY_CODE,
	t2.CURRENT_CODE AS ENTITY_CODE,
	t1.SCENARIO,
	t1.CREATED_TIME,
	t2.COUNTRY_ID,
	t2.CURRENCY_ID
FROM TRS_FACT_CFC_ENTITY_VERSION t1
LEFT JOIN V_TRS_DIM_ENTITY_CUR t2 ON t1.ENTITY_CODE = t2.ENTITY_CODE;


-- dbo.V_TRS_FACT_CFC_INV_RECOGNIZED_AMOUNT_DETAIL source

CREATE VIEW V_TRS_FACT_CFC_INV_RECOGNIZED_AMOUNT_DETAIL AS
WITH CTE_HEAD AS (
SELECT 
	PERIOD,
	BASE_ENTITY,
	INV_ENTITY,
	RATIO AS RATIO
FROM TEMP_TRS_FACT_CFC_RECOGNIZED_AMOUNT
),CTE_PERIOD AS (
	SELECT 
		PERIOD,
		ENTITY_CODE,
		SCENARIO
	FROM V_TRS_FACT_CFC_ENTITY_VERSION
), CTE_MV AS (
	SELECT
		T1.CURRENT_CODE AS ENTITY_CODE,
		T1.SCENARIO,
		PERIOD_DATE,
		T1.CURRENCY_CODE,
		--原始方向改正
		SUM(T1.ACCUMULATED_AMOUNT_ORI) * -1 AS ACCUMULATED_AMOUNT 
	FROM MV_TRS_TB_ACTUAL_ACCOUNT_AMOUNT T1
	WHERE SUBSTRING(T2_CODE, 1, 1) BETWEEN '4' AND '7'
	GROUP BY T1.CURRENT_CODE, T1.SCENARIO,  T1.CURRENCY_CODE,PERIOD_DATE
), CTE_ENTITY AS (
	SELECT 
		ENTITY_CODE,
		COUNTRY_ID,
		CURRENCY_ID
	FROM TRS_DIM_ENTITY
	--改取View不下條件
	--WHERE ENTITY_TYPE_ID = '003'
	--	AND IS_ACTIVE = 'true'
	UNION ALL
	SELECT
		ENTITY_CODE,
		COUNTRY_CODE,
		NULL AS CURRENCY_ID
	FROM TRS_DIM_EQUITY_INV_LIST
), INV_RECOGNIZED_AMOUNT AS(
SELECT
ID,
PERIOD,
--CFC_ENTITY_CODE,
t2.CURRENT_CODE AS CFC_ENTITY_CODE,
SCENARIO,
--CFC_INV_ENTITY_CODE,
t3.CURRENT_CODE AS CFC_INV_ENTITY_CODE,
t1.CURRENCY_ID,
RECOGNIZED_AMOUNT,
CFC_TAX,
RE_AMOUNT
FROM 
TRS_FACT_CFC_INV_RECOGNIZED_AMOUNT t1
LEFT JOIN V_TRS_DIM_ENTITY_CUR t2 ON t1.CFC_ENTITY_CODE =t2.ENTITY_CODE --取CFC_ENTITY_CODE現值
LEFT JOIN V_TRS_DIM_ENTITY_CUR t3 ON t1.CFC_INV_ENTITY_CODE =t3.ENTITY_CODE --取CFC_ENTITY_CODE現值
),EXCHANGE AS(
SELECT
CURRENCY_FACT_ID,
PERIOD,
PERIOD_DATE,
AVG_EXCHANGE_RATIO,
CURRENCY_ID,
SCENARIO
FROM V_TRS_FACT_EXCHANGE_BANKOFTW
WHERE TARGET_CURRENCY_ID = 'NTD' 
)
SELECT 
	t0.PERIOD,
	t0.SCENARIO,
	t1.BASE_ENTITY,
	t1.INV_ENTITY,
	ROUND(t1.RATIO, 4, 1) AS RATIO,
	t4.ID,
	t2.COUNTRY_ID,
	ISNULL(t3.IS_LOWTAX, t10.IS_LOWTAX) AS IS_LOWTAX,
	ISNULL(t2.CURRENCY_ID, t4.CURRENCY_ID) AS CURRENCY_ID,
	ISNULL(t5.AVG_EXCHANGE_RATIO, t11.AVG_EXCHANGE_RATIO) AS AVG_EXCHANGE_RATIO,
	ISNULL(t8.ACCUMULATED_AMOUNT, t4.RECOGNIZED_AMOUNT) AS AMOUNT,
	t4.RE_AMOUNT,
	t4.CFC_TAX,
	t6.CURRENCY_ID AS CFC_CURRENCY,
	t7.AVG_EXCHANGE_RATIO AS CFC_EXCHANGE_RATIO
FROM CTE_PERIOD t0
 JOIN CTE_HEAD t1 ON t0.PERIOD = t1.PERIOD AND t0.ENTITY_CODE = t1.BASE_ENTITY
JOIN CTE_ENTITY t2 ON t1.INV_ENTITY = t2.ENTITY_CODE --AND t2.ENTITY_TYPE_ID = '003'
inner JOIN TRS_FACT_CFC_ENTITY_VERSION_TAX t3 ON t2.COUNTRY_ID = t3.COUNTRY_ID AND t0.PERIOD = t3.PERIOD AND t3.IS_LOWTAX = 'false'
LEFT JOIN INV_RECOGNIZED_AMOUNT t4 ON t1.PERIOD = t4.PERIOD AND t1.BASE_ENTITY = t4.CFC_ENTITY_CODE AND t1.INV_ENTITY = t4.CFC_INV_ENTITY_CODE AND t0.SCENARIO = t4.SCENARIO
LEFT JOIN CTE_ENTITY t6 ON t1.BASE_ENTITY = t6.ENTITY_CODE --AND t6.ENTITY_TYPE_ID = '003'
LEFT JOIN EXCHANGE t7 ON t6.CURRENCY_ID = t7.CURRENCY_ID AND t7.PERIOD_DATE =  t1.PERIOD AND t0.SCENARIO = t7.SCENARIO 
LEFT JOIN CTE_MV t8 ON t8.PERIOD_DATE = t0.PERIOD AND t0.SCENARIO = t8.SCENARIO AND t1.INV_ENTITY = t8.ENTITY_CODE
LEFT JOIN EXCHANGE t5 ON t8.CURRENCY_CODE = t5.CURRENCY_ID AND t5.PERIOD_DATE = t1.PERIOD AND t0.SCENARIO = t5.SCENARIO
LEFT JOIN CTE_ENTITY t9 ON t4.CFC_INV_ENTITY_CODE = t9.ENTITY_CODE --AND t9.ENTITY_TYPE_ID = '003'
LEFT JOIN TRS_FACT_CFC_ENTITY_VERSION_TAX t10 ON t9.COUNTRY_ID = t10.COUNTRY_ID AND t0.PERIOD = t10.PERIOD
LEFT JOIN EXCHANGE t11 ON t4.CURRENCY_ID = t11.CURRENCY_ID AND t11.PERIOD_DATE = t4.PERIOD AND t4.SCENARIO = t11.SCENARIO;

-- dbo.V_TRS_FACT_CFC_REALIZED_LOSS source

CREATE VIEW V_TRS_FACT_CFC_REALIZED_LOSS ("ID", "CFC_ENTITY_CODE", "SCENARIO", "PERIOD", "INV_ENTITY_CODE", "NON_LOWTAX_ENTITY_CODE", "LOSS_DATE", "LOSS_TYPE", "CURRENCY_ID", "ORI_INV_AMOUNT", "LOSS_REALIZED_RATIO", "RATIO_HOLD", "AVG_EXCHANGE_RATIO", "REALIZED_LOSS_NTD", "CREATED_TIME") AS 
  WITH CTE_PERIOD AS (
SELECT
	PERIOD,
	SCENARIO,
	ENTITY_CODE
FROM V_TRS_FACT_CFC_ENTITY_VERSION
),REALIZED_LOSS AS(
SELECT
t1.ID,
t1.SCENARIO,
--t1.CFC_ENTITY_CODE,
t2.CURRENT_CODE AS CFC_ENTITY_CODE,--用current_code輸出
--t1.INV_ENTITY_CODE,
t3.CURRENT_CODE AS INV_ENTITY_CODE,--用current_code輸出
t1.NON_LOWTAX_ENTITY_CODE,
t1.LOSS_DATE,
t1.LOSS_TYPE,
t1.CURRENCY_ID,
t1.ORI_INV_AMOUNT,
t1.LOSS_REALIZED_RATIO,
t1.RATIO_HOLD,
t1.CREATED_TIME
FROM TRS_FACT_CFC_REALIZED_LOSS t1
LEFT JOIN V_TRS_DIM_ENTITY_CUR t2 ON t1.CFC_ENTITY_CODE = t2.ENTITY_CODE
LEFT JOIN V_TRS_DIM_ENTITY_CUR t3 ON t1.INV_ENTITY_CODE = t3.ENTITY_CODE
) 
SELECT
	t1.ID,
	t1.CFC_ENTITY_CODE,
	t0.SCENARIO,
	t0.PERIOD,
	t1.INV_ENTITY_CODE,
	t1.NON_LOWTAX_ENTITY_CODE,
	t1.LOSS_DATE,
	t1.LOSS_TYPE,
	t1.CURRENCY_ID,
	t1.ORI_INV_AMOUNT,
	t1.LOSS_REALIZED_RATIO,
	t1.RATIO_HOLD,
	t3.AVG_EXCHANGE_RATIO,
	FLOOR(t1.ORI_INV_AMOUNT * t1.LOSS_REALIZED_RATIO * t1.RATIO_HOLD * t3.AVG_EXCHANGE_RATIO) AS REALIZED_LOSS_NTD,
	t1.CREATED_TIME
FROM CTE_PERIOD t0
JOIN REALIZED_LOSS t1 ON t1.LOSS_DATE BETWEEN DATEFROMPARTS(YEAR(t0.PERIOD), 1, 1) AND t0.PERIOD AND t0.ENTITY_CODE = t1.CFC_ENTITY_CODE AND t0.SCENARIO = t1.SCENARIO
LEFT JOIN V_TRS_FACT_EXCHANGE_BANKOFTW t3 ON t1.CURRENCY_ID = t3.CURRENCY_ID AND t3.TARGET_CURRENCY_ID = 'NTD' AND t0.PERIOD = t3.PERIOD_DATE AND t1.SCENARIO = t3.SCENARIO;

-- dbo.V_TRS_FACT_CFC_INV_DIVIDEND source

CREATE VIEW V_TRS_FACT_CFC_INV_DIVIDEND AS
WITH DIVIDEND AS(
	SELECT
	t1.ID,
	t2.CURRENT_CODE AS CFC_ENTITY_CODE,--用current_code輸出
	t3.CURRENT_CODE AS CFC_INV_ENTITY_CODE,--用current_code輸出
	SCENARIO,
	DIVIDEND_TYPE,
	DECLARATION_DATE,
	FISCAL_YEAR,
	CREATED_BY,
	CREATED_TIME,
	UPDATED_BY,
	UPDATED_TIME,
	PERIOD,
	t1.CURRENCY_ID,
	AMOUNT,
	DEDUCTABLE_TAX,
	AMOUNT_DIFF_ADJ,
	TAX_CREDIT_DIFF_ADJ,
	RATIO_HOLD,
	CURRENCY_TAX,
	EXCHANGE_RATE_TAX
	FROM TRS_FACT_CFC_INV_DIVIDEND t1
	LEFT JOIN V_TRS_DIM_ENTITY_CUR t2 ON t1.CFC_ENTITY_CODE = t2.ENTITY_CODE
	LEFT JOIN V_TRS_DIM_ENTITY_CUR t3 ON t1.CFC_INV_ENTITY_CODE = t3.ENTITY_CODE
)
SELECT
        t4.ID,
        t1.ENTITY_CODE AS CFC_ENTITY_CODE,
        --t2.ENTITY_DISPLAY,
        t1.PERIOD,
        t1.SCENARIO,
        t4.CFC_INV_ENTITY_CODE,
        t2.COUNTRY_ID,
--        t2.CURRENT_CODE AS INV_CURRENT_CODE,
        t4.DIVIDEND_TYPE,
        t4.DECLARATION_DATE,
        t4.FISCAL_YEAR,
        t4.AMOUNT,
        t4.DEDUCTABLE_TAX,
        t4.CREATED_TIME,
        t3.IS_LOWTAX,
        t4.RATIO_HOLD,
        --t2.LANGUAGE,
        t4.AMOUNT_DIFF_ADJ,
        t4.TAX_CREDIT_DIFF_ADJ,
        FLOOR(t4.AMOUNT * t4.RATIO_HOLD * t5.AVG_EXCHANGE_RATIO) AS AMOUNT_BEFORE_ADJ,
		FLOOR((t4.AMOUNT * t4.RATIO_HOLD * t5.AVG_EXCHANGE_RATIO) + ISNULL(AMOUNT_DIFF_ADJ, 0)) AS AMOUNT_TOTAL,
		FLOOR(t4.DEDUCTABLE_TAX * t4.RATIO_HOLD * t4.EXCHANGE_RATE_TAX) AS TAX_CREDIT_BEFORE_ADJ,
		FLOOR((t4.DEDUCTABLE_TAX * t4.RATIO_HOLD * t4.EXCHANGE_RATE_TAX) + ISNULL(t4.TAX_CREDIT_DIFF_ADJ, 0)) AS TAX_CREDIT_TOTAL,
        t4.CURRENCY_ID,
        t5.AVG_EXCHANGE_RATIO,
--        t6.CURRENT_CODE AS CFC_CURRENT_CODE,
        t4.CURRENCY_TAX,
        t4.EXCHANGE_RATE_TAX
FROM V_TRS_FACT_CFC_ENTITY_VERSION t1
JOIN DIVIDEND t4 ON  t1.ENTITY_CODE = t4.CFC_ENTITY_CODE AND t1.SCENARIO = t4.SCENARIO AND t4.DECLARATION_DATE BETWEEN DATEFROMPARTS(YEAR(t1.PERIOD), 1, 1) AND t1.PERIOD
LEFT JOIN TRS_DIM_ENTITY t2 ON t4.CFC_INV_ENTITY_CODE = t2.ENTITY_CODE --AND ENTITY_TYPE_ID = '003'  AND t2."LANGUAGE" IS NOT NULL
LEFT JOIN TRS_FACT_CFC_ENTITY_VERSION_TAX t3 ON t2.COUNTRY_ID = t3.COUNTRY_ID AND T1.PERIOD = T3.PERIOD
LEFT JOIN V_TRS_FACT_EXCHANGE_BANKOFTW t5 ON t4.CURRENCY_ID = t5.CURRENCY_ID AND t5.TARGET_CURRENCY_ID = 'NTD' AND t1.PERIOD = t5.PERIOD_DATE AND t1.SCENARIO = t5.SCENARIO;




-- dbo.V_TRS_FACT_CFC_NONLOW_ADJ source

CREATE VIEW V_TRS_FACT_CFC_NONLOW_ADJ ("ID", "CFC_ENTITY_CODE", "SCENARIO", "PERIOD", "INV_ENTITY_CODE", "NON_LOWTAX_ENTITY_CODE", "DISPOSE_DATE", "CURRENCY_ID", "ORIGINAL_COST", "BOOK_VALUE", "AVG_EXCHANGE_RATIO", "RATIO_HOLD", "DISPOSE_ADJ_NTD", "SELL_COMPANY", "SELL_CURRENCY_ID", "INCOME_TAX", "SELL_RATIO_HOLD", "SELL_EXCHANGE_RATIO", "INCOME_TAX_NTD", "CREATED_TIME") AS 
  WITH CTE_PERIOD AS (
SELECT
	PERIOD,
	SCENARIO,
	ENTITY_CODE
FROM V_TRS_FACT_CFC_ENTITY_VERSION
),T AS( 
SELECT
	t1.ID,
	t1.SCENARIO,
	--t1.CFC_ENTITY_CODE,
	t2.CURRENT_CODE AS CFC_ENTITY_CODE,
	--t1.INV_ENTITY_CODE,
	t3.CURRENT_CODE AS INV_ENTITY_CODE,
	t1.NON_LOWTAX_ENTITY_CODE,
	t1.DISPOSE_DATE,
	t1.CURRENCY_ID,
	t1.ORIGINAL_COST,
	t1.BOOK_VALUE,
	t1.RATIO_HOLD,
	t1.SELL_COMPANY,
	t1.SELL_CURRENCY_ID,
	t1.INCOME_TAX,
	t1.SELL_RATIO_HOLD,
	t1.CREATED_TIME
FROM TRS_FACT_CFC_NONLOW_ADJ t1
LEFT JOIN V_TRS_DIM_ENTITY_CUR t2 ON t1.CFC_ENTITY_CODE = t2.ENTITY_CODE
LEFT JOIN V_TRS_DIM_ENTITY_CUR t3 ON t1.INV_ENTITY_CODE = t3.ENTITY_CODE
)
  SELECT
	t1.ID,
	t1.CFC_ENTITY_CODE,
	t0.SCENARIO,
	t0.PERIOD,
	t1.INV_ENTITY_CODE,
	t1.NON_LOWTAX_ENTITY_CODE,
	t1.DISPOSE_DATE,
	t1.CURRENCY_ID,
	t1.ORIGINAL_COST,
	t1.BOOK_VALUE,
	t3.AVG_EXCHANGE_RATIO,
	t1.RATIO_HOLD,
	FLOOR((t1.BOOK_VALUE - t1.ORIGINAL_COST) * t3.AVG_EXCHANGE_RATIO * t1.RATIO_HOLD)AS DISPOSE_ADJ_NTD,
	t1.SELL_COMPANY,
	t1.SELL_CURRENCY_ID,
	t1.INCOME_TAX,
	t1.SELL_RATIO_HOLD,
	t4.AVG_EXCHANGE_RATIO AS SELL_EXCHANGE_RATIO,
	FLOOR(t1.INCOME_TAX * t1.SELL_RATIO_HOLD * t4.AVG_EXCHANGE_RATIO)AS INCOME_TAX_NTD,
	t1.CREATED_TIME
FROM CTE_PERIOD t0
JOIN T t1 ON t1.DISPOSE_DATE BETWEEN DATEFROMPARTS(YEAR(t0.PERIOD), 1, 1) AND t0.PERIOD AND t0.ENTITY_CODE = t1.CFC_ENTITY_CODE AND t0.SCENARIO = t1.SCENARIO
LEFT JOIN V_TRS_FACT_EXCHANGE_BANKOFTW t3 ON t1.CURRENCY_ID = t3.CURRENCY_ID AND t3.TARGET_CURRENCY_ID = 'NTD' AND t0.PERIOD = t3.PERIOD_DATE AND t1.SCENARIO = t3.SCENARIO
LEFT JOIN V_TRS_FACT_EXCHANGE_BANKOFTW t4 ON t1.SELL_CURRENCY_ID = t4.CURRENCY_ID AND t4.TARGET_CURRENCY_ID = 'NTD' AND t0.PERIOD = t4.PERIOD_DATE AND t1.SCENARIO = t4.SCENARIO;


-- dbo.V_TRS_FACT_PASSIVE_INCOME_TOTAL source


CREATE VIEW V_TRS_FACT_PASSIVE_INCOME_TOTAL AS
WITH mv as(
SELECT
    T1.PERIOD_DATE AS PERIOD,
--    T1.MONTH,
    T1.CURRENT_CODE,
    T1.SCENARIO,
    T1.T5_CODE,
    T1.T5_NAME,
    T1.T4_CODE,
    T1.T4_NAME,
    T1.T5_DEBIT_CREDIT,
    T1.T4_DEBIT_CREDIT,
    T1.T3_CODE,
    T1.T3_NAME,
    T1.T3_DEBIT_CREDIT,
	CURRENCY_CODE,
    T1.ACCUMULATED_AMOUNT_ORI 
FROM MV_TRS_TB_ACTUAL_ACCOUNT_AMOUNT t1
JOIN TRS_FACT_CFC_ENTITY_VERSION_TAX t2 ON t1.COUNTRY_ID = t2.COUNTRY_ID   AND t1.PERIOD_DATE = T2.PERIOD
WHERE t2.IS_LOWTAX = 'true'
--INNER JOIN TRS_FACT_COUNTRY_TAX t2 ON t1.COUNTRY_ID = t2.COUNTRY_CODE AND t2.IS_LOWTAX = 'true'
)
,CTE0 AS (
SELECT
	PERIOD ,
--	MONTH,
	CURRENT_CODE AS ENTITY_CODE,
    SCENARIO,
	T5_CODE AS ACCOUNT_CODE,
	T5_NAME AS NAME,
	T5_DEBIT_CREDIT AS DEBIT_CREDIT,
	CURRENCY_CODE,
	ACCUMULATED_AMOUNT_ORI
FROM mv
WHERE 
	LEFT(T5_CODE, 1) = '4'
UNION ALL
SELECT
	PERIOD ,
--	MONTH,
	CURRENT_CODE AS ENTITY_CODE,
    SCENARIO,
	T4_CODE AS ACCOUNT_CODE,
	T4_NAME AS NAME,
	T4_DEBIT_CREDIT AS DEBIT_CREDIT,
	CURRENCY_CODE,
	ACCUMULATED_AMOUNT_ORI
FROM mv 
WHERE 
	LEFT(T4_CODE, 1) = '4'
	AND T5_CODE IS NULL
UNION ALL
SELECT
	PERIOD ,
--	MONTH,
	CURRENT_CODE AS ENTITY_CODE,
    SCENARIO,
	T3_CODE AS ACCOUNT_CODE,
	T3_NAME AS NAME,
	T3_DEBIT_CREDIT AS DEBIT_CREDIT,
	CURRENCY_CODE,
	ACCUMULATED_AMOUNT_ORI
FROM mv
WHERE 
	LEFT(T3_CODE, 1) = '4'
	AND T4_CODE IS NULL
UNION ALL
SELECT
	PERIOD ,
--	MONTH,
	CURRENT_CODE AS ENTITY_CODE,
    SCENARIO,
	T5_CODE AS ACCOUNT_CODE,
	T5_NAME AS NAME,
	T5_DEBIT_CREDIT AS DEBIT_CREDIT,
	CURRENCY_CODE,
	ACCUMULATED_AMOUNT_ORI
FROM mv
WHERE 
	LEFT(T5_CODE, 1) = '7'
UNION ALL
SELECT
	PERIOD ,
--	MONTH,
	CURRENT_CODE AS ENTITY_CODE,
    SCENARIO,
	T4_CODE AS ACCOUNT_CODE,
	T4_NAME AS NAME,
	T4_DEBIT_CREDIT AS DEBIT_CREDIT,
	CURRENCY_CODE,
	ACCUMULATED_AMOUNT_ORI
FROM mv
WHERE 
	LEFT(T4_CODE, 1) = '7'
	AND T5_CODE IS NULL
UNION ALL
SELECT
	PERIOD ,
--	MONTH,
	CURRENT_CODE AS ENTITY_CODE,
    SCENARIO,
	T3_CODE AS ACCOUNT_CODE,
	T3_NAME AS NAME,
	T3_DEBIT_CREDIT AS DEBIT_CREDIT,
	CURRENCY_CODE,
	ACCUMULATED_AMOUNT_ORI
FROM mv
WHERE 
	LEFT(T3_CODE, 1) = '7'
	AND T4_CODE IS NULL
),CTE AS(
SELECT
	CTE0.PERIOD,
	ENTITY_CODE,
    CTE0.SCENARIO,	
	ACCOUNT_CODE,
	NAME,
	DEBIT_CREDIT,
	CASE WHEN DEBIT_CREDIT = 'C' THEN ACCUMULATED_AMOUNT_ORI * T3.AVG_EXCHANGE_RATIO* -1 ELSE ACCUMULATED_AMOUNT_ORI* T3.AVG_EXCHANGE_RATIO END AS ACCUMULATED_AMOUNT_ORI
FROM CTE0
LEFT JOIN V_TRS_FACT_EXCHANGE_BANKOFTW T3 ON CTE0.PERIOD = T3.PERIOD_DATE AND CTE0.CURRENCY_CODE = T3.CURRENCY_ID AND TARGET_CURRENCY_ID = 'NTD' AND CTE0.SCENARIO = T3.SCENARIO
),CTE2 AS (
SELECT
	PERIOD,
	ENTITY_CODE,
    SCENARIO,
	SUM(CASE WHEN ACCOUNT_CODE IN ('7011', '7232', '7235', '7240', '730A', '730B', '730C', '730D', '730E', '730F', '7350', '7360', '7361', '7370', '7375') THEN ACCUMULATED_AMOUNT_ORI ELSE 0 END) AS INV_INCOME,
	SUM(CASE WHEN ACCOUNT_CODE IN ('7130') THEN ACCUMULATED_AMOUNT_ORI ELSE 0 END) AS DIV_INCOME,
	SUM(CASE WHEN ACCOUNT_CODE IN ('7101', '7102', '7105', '7106', '7107') THEN ACCUMULATED_AMOUNT_ORI ELSE 0 END) AS INT_INCOME,
	SUM(CASE WHEN ACCOUNT_CODE IN ('7120', '651C') THEN ACCUMULATED_AMOUNT_ORI ELSE 0 END) AS ROY_INCOME,
	SUM(CASE WHEN ACCOUNT_CODE IN ('7110', '651A') THEN ACCUMULATED_AMOUNT_ORI ELSE 0 END) AS RENT_INCOME,
	SUM(CASE WHEN ACCOUNT_CODE IN ('7210', '7215', '7220', '7225', '7229', '651B') THEN ACCUMULATED_AMOUNT_ORI ELSE 0 END) AS SALE_ASSETS_GAIN
FROM CTE
GROUP BY PERIOD, SCENARIO, ENTITY_CODE
), CTE_INV_CONTROL AS (
SELECT
	T1.ID,
	T1.PERIOD,
	T2.CURRENT_CODE AS ENTITY_CODE,
	T3.CURRENT_CODE AS INV_ENTITY_CODE
FROM TRS_FACT_INV_CONTROL T1
INNER JOIN V_TRS_DIM_ENTITY_CUR T2 ON T1.ENTITY_CODE = T2.ENTITY_CODE
INNER JOIN V_TRS_DIM_ENTITY_CUR T3 ON T1.INV_ENTITY_CODE = T3.ENTITY_CODE
WHERE RATIO_DIRECT != 0
), HEAD AS (
SELECT
	t1.ID,
	t0.PERIOD,
	t0.ENTITY_CODE,
	t0.SCENARIO,
	t1.INV_ENTITY_CODE,
	t3.COUNTRY_ID,
	t4.IS_LOWTAX
	--t5.COUNTRY_ID AS COMPANY_COUNTRY
FROM V_TRS_FACT_CFC_ENTITY_VERSION t0
INNER JOIN CTE_INV_CONTROL t1 ON t0.PERIOD = t1.PERIOD AND t0.ENTITY_CODE = t1.ENTITY_CODE
LEFT JOIN TRS_DIM_COMPANY t3 ON t1.INV_ENTITY_CODE = t3.COMPANY_CODE
JOIN TRS_FACT_CFC_ENTITY_VERSION_TAX t4 ON t3.COUNTRY_ID = t4.COUNTRY_ID   AND t0.PERIOD = T4.PERIOD
--INNER JOIN TRS_DIM_ENTITY t5 ON t0.ENTITY_CODE = t5.ENTITY_CODE  AND t5.COUNTRY_ID = 'TW'
WHERE t4.IS_LOWTAX='true' AND t0.COUNTRY_ID='TW'
),
CTE3_0 AS (
SELECT
	PERIOD ,
--	MONTH,
	CURRENT_CODE AS ENTITY_CODE,
    SCENARIO,
	T5_CODE AS ACCOUNT_CODE,
	T5_NAME AS NAME,
	T5_DEBIT_CREDIT AS DEBIT_CREDIT,
	CURRENCY_CODE,
	ACCUMULATED_AMOUNT_ORI
FROM mv
WHERE 
	LEFT(T5_CODE, 1) = '4'
UNION ALL
SELECT
	PERIOD ,
--	MONTH,
	CURRENT_CODE AS ENTITY_CODE,
    SCENARIO,
	T4_CODE AS ACCOUNT_CODE,
	T4_NAME AS NAME,
	T4_DEBIT_CREDIT AS DEBIT_CREDIT,
	CURRENCY_CODE,
	ACCUMULATED_AMOUNT_ORI
FROM mv
WHERE 
	LEFT(T4_CODE, 1) = '4'
	AND T5_CODE IS NULL
UNION ALL
SELECT
	PERIOD ,
--	MONTH,
	CURRENT_CODE AS ENTITY_CODE,
    SCENARIO,
	T3_CODE AS ACCOUNT_CODE,
	T3_NAME AS NAME,
	T3_DEBIT_CREDIT AS DEBIT_CREDIT,
	CURRENCY_CODE,
	ACCUMULATED_AMOUNT_ORI
FROM mv
WHERE 
	LEFT(T3_CODE, 1) = '4'
	AND T4_CODE IS NULL
UNION ALL
SELECT
	PERIOD ,
--	MONTH,
	CURRENT_CODE AS ENTITY_CODE,
    SCENARIO,
	T5_CODE AS ACCOUNT_CODE,
	T5_NAME AS NAME,
	T5_DEBIT_CREDIT AS DEBIT_CREDIT,
	CURRENCY_CODE,
	ACCUMULATED_AMOUNT_ORI
FROM mv
WHERE 
	LEFT(T5_CODE, 1) = '7'
UNION ALL
SELECT
	PERIOD ,
--	MONTH,
	CURRENT_CODE AS ENTITY_CODE,
    SCENARIO,
	T4_CODE AS ACCOUNT_CODE,
	T4_NAME AS NAME,
	T4_DEBIT_CREDIT AS DEBIT_CREDIT,
	CURRENCY_CODE,
	ACCUMULATED_AMOUNT_ORI
FROM mv
WHERE 
	LEFT(T4_CODE, 1) = '7'
	AND T5_CODE IS NULL
UNION ALL
SELECT
	PERIOD ,
--	MONTH,
	CURRENT_CODE AS ENTITY_CODE,
    SCENARIO,
	T3_CODE AS ACCOUNT_CODE,
	T3_NAME AS NAME,
	T3_DEBIT_CREDIT AS DEBIT_CREDIT,
	CURRENCY_CODE,
	ACCUMULATED_AMOUNT_ORI
FROM mv
WHERE 
	LEFT(T3_CODE, 1) = '7'
	AND T4_CODE IS NULL
),CTE3 AS (
SELECT
	CTE3_0.PERIOD,
	ENTITY_CODE,
    CTE3_0.SCENARIO,	
	ACCOUNT_CODE,
	NAME,
	DEBIT_CREDIT,
	CASE WHEN DEBIT_CREDIT = 'C' THEN ACCUMULATED_AMOUNT_ORI * T3.AVG_EXCHANGE_RATIO* -1 ELSE ACCUMULATED_AMOUNT_ORI* T3.AVG_EXCHANGE_RATIO END AS ACCUMULATED_AMOUNT_ORI
FROM CTE3_0
LEFT JOIN V_TRS_FACT_EXCHANGE_BANKOFTW T3 ON CTE3_0.PERIOD  = T3.PERIOD_DATE AND CTE3_0.CURRENCY_CODE = T3.CURRENCY_ID AND TARGET_CURRENCY_ID = 'NTD' AND CTE3_0.SCENARIO = T3.SCENARIO
), TOTAL AS (
SELECT
	PERIOD,
	SCENARIO,
	ENTITY_CODE,
	SUM(CASE WHEN LEFT(ACCOUNT_CODE, 1) = '4' THEN ACCUMULATED_AMOUNT_ORI ELSE 0 END) AS TOTAL_OPE_INCOME,
	SUM(CASE WHEN LEFT(ACCOUNT_CODE, 1) = '7' AND DEBIT_CREDIT = 'C' AND ACCUMULATED_AMOUNT_ORI > 0 THEN ACCUMULATED_AMOUNT_ORI ELSE 0 END) - SUM(CASE WHEN ACCOUNT_CODE IN ('7233', '7630') AND ACCUMULATED_AMOUNT_ORI < 0 THEN ACCUMULATED_AMOUNT_ORI ELSE 0 END)AS TOTAL_NONOPE_INCOME
FROM CTE3
GROUP BY PERIOD, SCENARIO, ENTITY_CODE
)
, TB_RES AS (
SELECT
	HEAD.ID,
	HEAD.COUNTRY_ID,
	HEAD.ENTITY_CODE,
	HEAD.IS_LOWTAX,
	HEAD.PERIOD,
    HEAD.SCENARIO,
	HEAD.INV_ENTITY_CODE,
	CTE2.INV_INCOME,
	CTE2.DIV_INCOME,
	CTE2.INT_INCOME,
	CTE2.ROY_INCOME,
	CTE2.RENT_INCOME,
	CTE2.SALE_ASSETS_GAIN,
    0 AS SELF_DEV_ROY,
    0 AS SELF_DEV_RENT,
    0 AS SELF_DEV_GAIN,
    CTE2.INV_INCOME + CTE2.DIV_INCOME + CTE2.INT_INCOME + CTE2.ROY_INCOME + CTE2.RENT_INCOME + CTE2.SALE_ASSETS_GAIN AS TOTAL_NUMERATOR,
    TOTAL.TOTAL_OPE_INCOME,
    TOTAL.TOTAL_NONOPE_INCOME,
    TOTAL.TOTAL_OPE_INCOME + TOTAL.TOTAL_NONOPE_INCOME AS TOTAL_DENOMINATOR
FROM HEAD
LEFT JOIN CTE2 ON HEAD.INV_ENTITY_CODE = CTE2.ENTITY_CODE AND HEAD.PERIOD = CTE2.PERIOD AND HEAD.SCENARIO = CTE2.SCENARIO
LEFT JOIN TOTAL ON HEAD.INV_ENTITY_CODE = TOTAL.ENTITY_CODE AND HEAD.PERIOD = TOTAL.PERIOD AND HEAD.SCENARIO = TOTAL.SCENARIO
),CTE_ADJ AS (
SELECT
	T1.PERIOD,
	T2.CURRENT_CODE AS CFC_ENTITY_CODE,
	T1.SCENARIO,
	T1.INV_INCOME,
	T1.DIV_INCOME,
	T1.INT_INCOME ,
	T1.ROY_INCOME ,
	T1.RENT_INCOME ,
	T1.SALE_ASSETS_GAIN ,
	T1.SELF_DEV_ROY ,
	T1.SELF_DEV_RENT ,
	T1.SELF_DEV_GAIN ,
	T1.TOTAL_NUMERATOR ,
	T1.TOTAL_OPE_INCOME ,
	T1.TOTAL_NONOPE_INCOME ,
	T1.TOTAL_DENOMINATOR 
FROM TRS_FACT_PASSIVE_INCOME_ADJ T1
LEFT JOIN V_TRS_DIM_ENTITY_CUR T2 ON T1.CFC_ENTITY_CODE = T2.ENTITY_CODE 
)
SELECT 
	T1.ID,
	T1.PERIOD,
	T1.SCENARIO,
	T1.IS_LOWTAX,
	T1.COUNTRY_ID,
	T1.ENTITY_CODE,
	T1.INV_ENTITY_CODE,
	T1.INV_INCOME,
	T1.DIV_INCOME,
	T1.INT_INCOME,
	T1.ROY_INCOME,
	T1.RENT_INCOME,
	T1.SALE_ASSETS_GAIN,
	T1.TOTAL_OPE_INCOME,
	T1.TOTAL_NONOPE_INCOME,
	T2.INV_INCOME AS INV_INCOME_ADJ,
	T2.DIV_INCOME AS DIV_INCOME_ADJ,
	T2.INT_INCOME AS INT_INCOME_ADJ,
	T2.ROY_INCOME AS ROY_INCOME_ADJ,
	T2.RENT_INCOME AS RENT_INCOME_ADJ,
	T2.SELF_DEV_ROY AS SELF_DEV_ROY_ADJ,
    T2.SELF_DEV_RENT AS SELF_DEV_RENT_ADJ,
    T2.SELF_DEV_GAIN AS SELF_DEV_GAIN_ADJ,
	T2.SALE_ASSETS_GAIN AS SALE_ASSETS_GAIN_ADJ,
	T2.TOTAL_OPE_INCOME AS TOTAL_OPE_INCOME_ADJ,
	T2.TOTAL_NONOPE_INCOME AS TOTAL_NONOPE_INCOME_ADJ,
	T1.INV_INCOME + isnull(T2.INV_INCOME, 0) AS INV_INCOME_TOTAL,
	T1.DIV_INCOME + isnull(T2.DIV_INCOME, 0) AS DIV_INCOME_TOTAL,
	T1.INT_INCOME + isnull(T2.INT_INCOME, 0) AS INT_INCOME_TOTAL, 
	T1.ROY_INCOME + isnull(T2.ROY_INCOME, 0) AS ROY_INCOME_TOTAL,
	T1.RENT_INCOME + isnull(T2.RENT_INCOME, 0) AS RENT_INCOME_TOTAL,
	T1.SALE_ASSETS_GAIN + isnull(T2.SALE_ASSETS_GAIN, 0) AS SALE_ASSETS_GAIN_TOTAL,
	T1.SELF_DEV_ROY + isnull(T2.SELF_DEV_ROY, 0) AS SELF_DEV_ROY_TOTAL,
	T1.SELF_DEV_RENT + isnull(T2.SELF_DEV_RENT, 0) AS SELF_DEV_RENT_TOTAL,
	T1.SELF_DEV_GAIN + isnull(T2.SELF_DEV_GAIN, 0) AS SELF_DEV_GAIN_TOTAL,
	T1.TOTAL_NUMERATOR + isnull(T2.TOTAL_NUMERATOR, 0) AS TOTAL_NUMERATOR_TOTAL,
	T1.TOTAL_OPE_INCOME + isnull(T2.TOTAL_OPE_INCOME, 0) AS TOTAL_OPE_INCOME_TOTAL,
	T1.TOTAL_NONOPE_INCOME +isnull(T2.TOTAL_NONOPE_INCOME, 0)AS TOTAL_NONOPE_INCOME_TOTAL,
	T1.TOTAL_DENOMINATOR +isnull(T2.TOTAL_DENOMINATOR, 0) AS TOTAL_DENOMINATOR_TOTAL,
	ROUND (CASE WHEN (T1.TOTAL_DENOMINATOR + isnull(T2.TOTAL_DENOMINATOR, 0)) IS NULL OR (T1.TOTAL_DENOMINATOR +isnull(T2.TOTAL_DENOMINATOR, 0)) = 0 THEN 1 ELSE
	(T1.TOTAL_NUMERATOR + isnull(T2.TOTAL_NUMERATOR, 0)) / (T1.TOTAL_DENOMINATOR + isnull(T2.TOTAL_DENOMINATOR, 0)) END , 4,1)AS PASSIVE_RATIO_TOTAL
FROM TB_RES T1
LEFT JOIN CTE_ADJ T2 ON T1.PERIOD = T2.PERIOD AND T1.INV_ENTITY_CODE = T2.CFC_ENTITY_CODE AND T1.SCENARIO = T2.SCENARIO;

-- dbo.V_TRS_FACT_CFC_EXEMPTION source

CREATE VIEW V_TRS_FACT_CFC_EXEMPTION AS
WITH CTE_PERIOD AS (
	SELECT
		t1.PERIOD,
		t1.ENTITY_CODE,
		t1.SCENARIO,
		t1.COUNTRY_ID AS COMPANY_COUNTRY
	FROM V_TRS_FACT_CFC_ENTITY_VERSION t1
	WHERE t1.COUNTRY_ID = 'TW'
 ) ,CTE AS (
--從MVIEW取薪資相關費用
SELECT
	T1.PERIOD_DATE AS PERIOD,
	T1.CURRENT_CODE AS ENTITY_CODE,
    T1.SCENARIO,
	T1.T4_CODE AS ACCOUNT_CODE,
	T1.T4_NAME AS NAME,
	T1.T4_DEBIT_CREDIT AS DEBIT_CREDIT,
	SUM(isnull(ACCUMULATED_AMOUNT, 0) * T3.AVG_EXCHANGE_RATIO) AS SALARY
FROM MV_TRS_TB_ACTUAL_ACCOUNT_AMOUNT T1
LEFT JOIN V_TRS_FACT_EXCHANGE_BANKOFTW T3 ON T1.PERIOD_DATE = T3.PERIOD_DATE AND T1.CURRENCY_CODE = T3.CURRENCY_ID AND TARGET_CURRENCY_ID = 'NTD' AND T1.SCENARIO = T3.SCENARIO 
WHERE 
	T1.T4_CODE IN ('5113', '5145', '5146', '5147' ,'6110', '6210','6310','6128','6228', '6328','6145','6245','6353','6146','6246','6354','6236','6317')
GROUP BY T1.PERIOD_DATE,
T1.CURRENT_CODE, T1.SCENARIO, T1.T4_CODE, T1.T4_NAME, T1.T4_DEBIT_CREDIT
), CTE_INV_CONTROL AS (
SELECT
	T1.ID,
	T1.PERIOD,
	T2.CURRENT_CODE AS ENTITY_CODE,
	T3.CURRENT_CODE AS INV_ENTITY_CODE,
	t1.RATIO_SUM,
	t1.RATIO_DIRECT,
	t1.RATIO_INDIRECT,
	t1.UPDATED_TIME
FROM TRS_FACT_INV_CONTROL T1
JOIN V_TRS_DIM_ENTITY_CUR T2 ON T1.ENTITY_CODE = T2.ENTITY_CODE
JOIN V_TRS_DIM_ENTITY_CUR T3 ON T1.INV_ENTITY_CODE = T3.ENTITY_CODE
WHERE RATIO_DIRECT != 0
),CTE_INFO AS (
SELECT
	t2.PERIOD ,
	t1.CURRENT_CODE AS CFC_ENTITY_CODE ,
	t2.SCENARIO ,
	t2.ID,
	t2.FIXED_PLACE,
	t2.NUM_OF_EMPLOYEES,
	t2.FINANCIAL_REPORT,
	t2.FIXED_PLACE_ATTACH,
	t2.FIXED_PLACE_ATTACH_NAME,
	t2.EMPLOYEE_ATTACH,
	t2.EMPLOYEE_ATTACH_NAME,
	t2.ATTACH1,
	t2.ATTACH1_NAME,
	t2.ATTACH2,
	t2.ATTACH2_NAME,
	t2.ATTACH3,
	t2.ATTACH3_NAME
FROM TRS_FACT_CFC_INFO T2
LEFT JOIN V_TRS_DIM_ENTITY_CUR T1 ON T2.CFC_ENTITY_CODE = ENTITY_CODE
),CTE_CONTROL AS (
SELECT
T1.PERIOD ,
T1.SCENARIO,
T2.CURRENT_CODE AS ENTITY_CODE ,
T3.CURRENT_CODE AS INV_ENTITY_CODE ,
T1.ACTUAL_CONTROL
FROM TRS_FACT_INV_ACTUAL_CONTROL T1
LEFT JOIN V_TRS_DIM_ENTITY_CUR T2 ON T1.ENTITY_CODE = T2.ENTITY_CODE 
LEFT JOIN V_TRS_DIM_ENTITY_CUR T3 ON T1.INV_ENTITY_CODE = T3.ENTITY_CODE 
)
SELECT 
	t2.ID,
	t0.PERIOD,
	t0.ENTITY_CODE,
	t1.INV_ENTITY_CODE,
--	t3.COMPANY_NAME,
	t1.RATIO_SUM,
	t1.RATIO_DIRECT,
	t1.RATIO_INDIRECT,
	t1.UPDATED_TIME,
	t2.FIXED_PLACE,
	t2.NUM_OF_EMPLOYEES,
	CTE.SALARY,
	t2.FINANCIAL_REPORT,
	t2.FIXED_PLACE_ATTACH,
	t2.FIXED_PLACE_ATTACH_NAME,
	t2.EMPLOYEE_ATTACH,
	t2.EMPLOYEE_ATTACH_NAME,
	t2.ATTACH1,
	t2.ATTACH1_NAME,
	t2.ATTACH2,
	t2.ATTACH2_NAME,
	t2.ATTACH3,
	t2.ATTACH3_NAME,
	t3.COUNTRY_ID,
	t3.LOCAL_CURRENCY_ID,
	t4.IS_LOWTAX,
	t0.SCENARIO,
	t5.PASSIVE_RATIO_TOTAL,
--	t3.ADDRESS,
	CASE WHEN t2.FIXED_PLACE = 'true' AND t2.NUM_OF_EMPLOYEES > 0 AND t5.PASSIVE_RATIO_TOTAL < 0.1 THEN 'true' ELSE 'false' END AS SUB_OPE_EXEMPTION,
	t7.ACTUAL_CONTROL,
	CASE WHEN t1.RATIO_SUM >= 0.5 OR t7.ACTUAL_CONTROL = 'true' THEN 'true' ELSE 'false' END AS IS_CFC
FROM CTE_PERIOD t0
LEFT JOIN CTE_INV_CONTROL t1 ON t0.PERIOD = t1.PERIOD AND t0.ENTITY_CODE = t1.ENTITY_CODE 
LEFT JOIN CTE_INFO t2 ON t1.PERIOD = t2.PERIOD AND t1.INV_ENTITY_CODE = t2.CFC_ENTITY_CODE AND t0.SCENARIO = t2.SCENARIO
LEFT JOIN TRS_DIM_COMPANY t3 ON t1.INV_ENTITY_CODE = t3.COMPANY_CODE 
JOIN TRS_FACT_CFC_ENTITY_VERSION_TAX t4 ON t3.COUNTRY_ID = t4.COUNTRY_ID  AND T1.PERIOD = T4.PERIOD
LEFT JOIN V_TRS_FACT_PASSIVE_INCOME_TOTAL t5 ON t0.PERIOD = t5.PERIOD AND t0.ENTITY_CODE = t5.ENTITY_CODE AND t1.INV_ENTITY_CODE = t5.INV_ENTITY_CODE AND t0.SCENARIO = t5.SCENARIO
LEFT JOIN CTE ON t1.INV_ENTITY_CODE = CTE.ENTITY_CODE AND t0.PERIOD = CTE.PERIOD AND t5.SCENARIO = CTE.SCENARIO 
LEFT JOIN CTE_CONTROL t7 ON t1.ENTITY_CODE = t7.ENTITY_CODE AND t1.PERIOD = t7.PERIOD AND t1.INV_ENTITY_CODE = t7.INV_ENTITY_CODE AND t0.SCENARIO = t7.SCENARIO
WHERE t4.IS_LOWTAX = 'true';

-- dbo.V_TRS_FACT_CFC_RATIO_HOLD source

CREATE VIEW V_TRS_FACT_CFC_RATIO_HOLD ("PERIOD", "ENTITY_CODE","COUNTRY_ID", "INV_ENTITY_CODE", "RATIO_HOLD", "START_DATE", "END_DATE", "DATE_DIF", "TOTAL_DAYS", "AVG_RATIO_HOLD") AS 
WITH PERIOD AS(
--篩出全部年月
SELECT  
PERIOD
FROM TRS_FACT_CFC_ENTITY_VERSION_PERIOD
),CTE AS (
--先篩出符合年月條件的投資明細
SELECT
        PERIOD,
        ENTITY_CODE,
        INV_ENTITY_CODE,
        RATIO_HOLD,
		CASE WHEN (END_DATE < DATEFROMPARTS(YEAR(PERIOD), 1, 1) OR START_DATE > PERIOD) THEN NULL 
		WHEN YEAR(START_DATE) < YEAR(PERIOD) THEN DATEFROMPARTS(YEAR(PERIOD), 1, 1)
        ELSE START_DATE END AS START_DATE,
        --若起始年度小於PERIOD則改成當年度第一天
        CASE WHEN (END_DATE < DATEFROMPARTS(YEAR(PERIOD), 1, 1) OR START_DATE > PERIOD) THEN NULL 
		WHEN END_DATE >= PERIOD THEN PERIOD
        ELSE END_DATE END AS END_DATE
        --若結束日期大於PERIOD則改成PERIOD當年度第一天
FROM PERIOD
LEFT JOIN TRS_FACT_GROUP_INV_REL ON 1=1-- NOT (END_DATE < DATEFROMPARTS(YEAR(PERIOD), 1, 1) OR START_DATE > PERIOD)
--篩掉起訖區間完全沒包含到PERIOD及該年度01/01
WHERE 1 = 1
)SELECT
--計算日期加權平均
       t1.PERIOD,
       ISNULL(t2.CURRENT_CODE, t1.ENTITY_CODE) AS ENTITY_CODE,
       t2.COUNTRY_ID,
       ISNULL(t3.CURRENT_CODE, t1.INV_ENTITY_CODE) AS INV_ENTITY_CODE,
        RATIO_HOLD,START_DATE,END_DATE,
        DATEDIFF(DAY, START_DATE, END_DATE) + 1 AS DATE_DIF, --計算持有天數
        (DATEDIFF(DAY, DATEFROMPARTS(YEAR(PERIOD), 1, 1), PERIOD) + 1) AS TOTAL_DAYS, --計算至年月版本的總天數
        ROUND(((DATEDIFF(DAY, START_DATE, END_DATE) + 1) * RATIO_HOLD / (DATEDIFF(DAY, DATEFROMPARTS(YEAR(PERIOD), 1, 1), PERIOD) + 1)), 5) AS AVG_RATIO_HOLD
        --直接持有比例*持有天數/至年月版本天數=加權平均持有比例
FROM CTE t1
LEFT JOIN V_TRS_DIM_ENTITY_CUR t2 ON t1.ENTITY_CODE = t2.ENTITY_CODE
LEFT JOIN V_TRS_DIM_ENTITY_CUR t3 ON t1.INV_ENTITY_CODE = t3.ENTITY_CODE
WHERE START_DATE IS NOT NULL;

-- dbo.V_TRS_FACT_CFC_TAX_INCOME source

CREATE VIEW V_TRS_FACT_CFC_TAX_INCOME AS
WITH CTE0 AS (
SELECT
	t1.PERIOD,
	t1.ENTITY_CODE,
	t1.SCENARIO
FROM V_TRS_FACT_CFC_ENTITY_VERSION t1
WHERE T1.COUNTRY_ID != 'TW'
),CTE_REC_AMT_TOTAL AS (
SELECT
	T1.PERIOD ,
	T1.SCENARIO ,
	T2.CURRENT_CODE AS CFC_ENTITY_CODE,
	T1.TAX_REV_TOTAL,
	T1.TAX_EXP_TOTAL,
	T1.RE_ADD_TOTAL,
	T1.RE_LESS_TOTAL
FROM TRS_FACT_CFC_INV_RECOGNIZED_AMOUNT_TOTAL T1
LEFT JOIN V_TRS_DIM_ENTITY_CUR T2 ON T1.CFC_ENTITY_CODE = T2.ENTITY_CODE 
)
,CTE AS (
SELECT
	t1.PERIOD,
	t1.SCENARIO,
	t1.BASE_ENTITY AS CFC_ENTITY_CODE,
	SUM(FLOOR(t1.AMOUNT * t1.AVG_EXCHANGE_RATIO * t1.RATIO)) + SUM(FLOOR(isnull(t1.RE_AMOUNT, 0) * t1.AVG_EXCHANGE_RATIO * t1.RATIO)) AS AMOUNT_NTD,
	SUM(FLOOR(t1.CFC_TAX * t1.CFC_EXCHANGE_RATIO)) AS CFC_TAX_NTD,
	FLOOR(t2.TAX_REV_TOTAL * t1.CFC_EXCHANGE_RATIO) AS TAX_REV_TOTAL,
	FLOOR(t2.TAX_EXP_TOTAL * t1.CFC_EXCHANGE_RATIO)AS TAX_EXP_TOTAL
FROM V_TRS_FACT_CFC_INV_RECOGNIZED_AMOUNT_DETAIL t1
LEFT JOIN CTE_REC_AMT_TOTAL t2 ON t1.PERIOD = t2.PERIOD AND t1.BASE_ENTITY = t2.CFC_ENTITY_CODE AND t1.SCENARIO = t2.SCENARIO
WHERE t1.AMOUNT IS NOT NULL AND IS_LOWTAX = 'false'
GROUP BY t1.PERIOD, t1.SCENARIO, t1.BASE_ENTITY, TAX_REV_TOTAL, (t2.TAX_REV_TOTAL * t1.CFC_EXCHANGE_RATIO), (t2.TAX_EXP_TOTAL * t1.CFC_EXCHANGE_RATIO)
), CTE2 AS (
SELECT
	t1.PERIOD,
	t1.SCENARIO,
	t1.CFC_ENTITY_CODE,
	(isnull(AMOUNT_NTD, 0) + CASE WHEN TAX_REV_TOTAL IS NOT NULL OR TAX_EXP_TOTAL IS NOT NULL THEN isnull(TAX_REV_TOTAL, 0) + isnull(TAX_EXP_TOTAL, 0) ELSE isnull(CFC_TAX_NTD, 0) END) AS AMOUNT_TOTAL
FROM CTE t1
)
,CTE3 AS (
--自”獲配股利及實際虧損”頁面取數，加總非低稅區國家項目、金額為負之”CFC實際獲配/實際虧損金額”之金額並乘以-1
	SELECT 
		t1.PERIOD,
		t1.SCENARIO,
		t1.CFC_ENTITY_CODE,
		SUM(t1.REALIZED_LOSS_NTD) AS REALIZED_LOSS
	FROM V_TRS_FACT_CFC_REALIZED_LOSS t1
	GROUP BY t1.PERIOD, t1.SCENARIO, t1.CFC_ENTITY_CODE
),CTE_INV_DIVIDEND AS (
SELECT
	t1.PERIOD,
	t1.SCENARIO,
	t1.CFC_ENTITY_CODE,
	t1.AMOUNT_TOTAL AS AMOUNT,
	t1.RATIO_HOLD,
	t1.AVG_EXCHANGE_RATIO,
	isnull(t1.TAX_CREDIT_TOTAL, 0)AS DEDUCTABLE_TAX,
	t1.IS_LOWTAX,
	t1.COUNTRY_ID,
	t1.DECLARATION_DATE,
	t1.FISCAL_YEAR
FROM V_TRS_FACT_CFC_INV_DIVIDEND t1
WHERE AMOUNT_TOTAL > 0
	AND IS_LOWTAX = 'false' --FALSE
	AND (DECLARATION_DATE >= cast('2024-04-01' as datetime) OR FISCAL_YEAR >= 2023)
)
,CTE4 AS (
--自”獲配股利及實際虧損”頁面取數，加總非低稅區國家項目且非中國大陸、金額為正之”CFC實際獲配/實際虧損金額減除可扣抵稅額”之金額
	SELECT
		t1.PERIOD,
		t1.SCENARIO,
		t1.CFC_ENTITY_CODE,
		round(SUM(t1.AMOUNT - DEDUCTABLE_TAX), 5,1) AS DISTRI_NONCN
	FROM CTE_INV_DIVIDEND t1
	WHERE COUNTRY_ID != 'CN'
	GROUP BY t1.PERIOD, t1.SCENARIO, t1.CFC_ENTITY_CODE
)
,CTE5 AS (
--盈餘分配數
--自”獲配股利及實際虧損”頁面取數，加總非低稅區國家項目且為中國大陸、金額為正之”CFC實際獲配/實際虧損金額”之金額
	SELECT
		t1.PERIOD,
		t1.SCENARIO,
		t1.CFC_ENTITY_CODE,
		ROUND (SUM(t1.AMOUNT), 5,1) AS DISTRI_CN
	FROM CTE_INV_DIVIDEND t1
	WHERE COUNTRY_ID = 'CN'
	GROUP BY t1.PERIOD, t1.SCENARIO, t1.CFC_ENTITY_CODE
),CTE8 AS (
--稅後淨利
--依篩選項加總TB數據，將4、5、6、7開頭科目加總
	SELECT
		T1.CURRENT_CODE AS ENTITY_CODE,
		T1.SCENARIO,
		--有些月份是06有些是6，統一格式
		T1.PERIOD_DATE AS PERIOD,
		FLOOR(SUM(T1.ACCUMULATED_AMOUNT_ORI * -1 * T3.AVG_EXCHANGE_RATIO))AS ACCUMULATED_AMOUNT 
	FROM MV_TRS_TB_ACTUAL_ACCOUNT_AMOUNT T1
	--JOIN TRS_DIM_ENTITY t2 ON t1.ENTITY_CODE = t2.ENTITY_CODE AND T2.COUNTRY_ID != 'TW'
	LEFT JOIN V_TRS_FACT_EXCHANGE_BANKOFTW T3 ON T1.PERIOD_DATE = T3.PERIOD_DATE AND T1.CURRENCY_CODE = T3.CURRENCY_ID AND TARGET_CURRENCY_ID = 'NTD' AND T1.SCENARIO = T3.SCENARIO 
	WHERE LEFT(T2_CODE, 1) BETWEEN '4' AND '7' 
	AND T1.COUNTRY_ID != 'TW'
	GROUP BY T1.CURRENT_CODE, T1.SCENARIO, T1.PERIOD_DATE
)
,CTE_NONLOW AS (
	SELECT
		PERIOD,
		SCENARIO,
		CFC_ENTITY_CODE,
		SUM(DISPOSE_ADJ_NTD + isnull(INCOME_TAX_NTD, 0)) AS NON_CFC_DISPOSAL_ADJ
	FROM V_TRS_FACT_CFC_NONLOW_ADJ
	GROUP BY CFC_ENTITY_CODE, SCENARIO, PERIOD
),CTE_RATIO_HOLD AS (
	SELECT
		ENTITY_CODE,
		PERIOD,
		INV_ENTITY_CODE,
		ROUND(SUM(AVG_RATIO_HOLD), 4,1) AS AVG_RATIO_HOLD
	FROM V_TRS_FACT_CFC_RATIO_HOLD
	GROUP BY ENTITY_CODE, PERIOD, INV_ENTITY_CODE
),CTE9 AS (
SELECT
	CTE0.PERIOD,
	CTE0.SCENARIO,
	CTE0.ENTITY_CODE AS CFC_ENTITY_CODE,
	CTE8.ACCUMULATED_AMOUNT,
	CTE2.AMOUNT_TOTAL,
	CTE3.REALIZED_LOSS,
	CTE4.DISTRI_NONCN,
	CTE5.DISTRI_CN,
	CTE_NONLOW.NON_CFC_DISPOSAL_ADJ
FROM CTE0
LEFT JOIN CTE2 ON CTE0.PERIOD = CTE2.PERIOD AND CTE0.SCENARIO = CTE2.SCENARIO AND CTE0.ENTITY_CODE = CTE2.CFC_ENTITY_CODE
LEFT JOIN CTE3 ON CTE0.SCENARIO = CTE3.SCENARIO AND CTE0.PERIOD = CTE3.PERIOD AND CTE0.ENTITY_CODE = CTE3.CFC_ENTITY_CODE 
LEFT JOIN CTE4 ON CTE0.SCENARIO = CTE4.SCENARIO AND CTE4.PERIOD = CTE0.PERIOD AND CTE0.ENTITY_CODE = CTE4.CFC_ENTITY_CODE 
LEFT JOIN CTE5 ON CTE0.SCENARIO = CTE5.SCENARIO AND CTE5.PERIOD = CTE0.PERIOD AND CTE0.ENTITY_CODE = CTE5.CFC_ENTITY_CODE 
LEFT JOIN CTE8 ON CTE8.PERIOD = CTE0.PERIOD AND CTE0.SCENARIO = CTE8.SCENARIO AND CTE0.ENTITY_CODE = CTE8.ENTITY_CODE
LEFT JOIN CTE_NONLOW ON CTE0.PERIOD = CTE_NONLOW.PERIOD AND CTE0.SCENARIO = CTE_NONLOW.SCENARIO AND CTE0.ENTITY_CODE = CTE_NONLOW.CFC_ENTITY_CODE
),CTE_EXEMPTION AS (
SELECT
	t1.ENTITY_CODE,
	t1.INV_ENTITY_CODE,
	t1.PERIOD,
	t1.SCENARIO,
	t1.SUB_OPE_EXEMPTION,
	t1.COUNTRY_ID,
	t1.LOCAL_CURRENCY_ID
FROM V_TRS_FACT_CFC_EXEMPTION t1
WHERE t1.IS_CFC = 'true'
),CTE_OTHER_AMOUNT AS (
SELECT
	T1.PERIOD ,
	T2.CURRENT_CODE AS INV_ENTITY_CODE,
	T1.SCENARIO ,
	T1.DESPITE_PROFIT,
	T1.FVPL_AMOUNT,
	T1.FVPL_FVCHANGE,
	T1.RE_FVPL_AMOUNT
FROM TRS_FACT_CFC_OTHER_AMOUNT T1
LEFT JOIN V_TRS_DIM_ENTITY_CUR T2 ON T1.INV_ENTITY_CODE = T2.ENTITY_CODE 
),CTE_FVPL AS (
SELECT
	T1.PERIOD ,
	T1.FVPL_APP,
	T2.CURRENT_CODE AS ENTITY_CODE 
FROM TRS_FACT_FVPL_EXEMPTION T1
LEFT JOIN V_TRS_DIM_ENTITY_CUR T2 ON T1.ENTITY_CODE = T2.ENTITY_CODE 
)
SELECT 
	t1.ENTITY_CODE,
	t1.INV_ENTITY_CODE,
	t1.PERIOD,
	t1.SCENARIO,
	t1.SUB_OPE_EXEMPTION,
	t1.COUNTRY_ID,
	t1.LOCAL_CURRENCY_ID,
	CTE9.ACCUMULATED_AMOUNT,
	CTE9.AMOUNT_TOTAL,
	CTE9.REALIZED_LOSS,
	CTE9.DISTRI_NONCN,
	CTE9.DISTRI_CN,
	t2.DESPITE_PROFIT,
	t4.FVPL_APP,
	CASE WHEN t4.FVPL_APP != 'Y' THEN 0 ELSE t2.FVPL_FVCHANGE END AS FVPL_FVCHANGE,
	CASE WHEN t4.FVPL_APP != 'Y' THEN 0 ELSE t2.FVPL_AMOUNT END AS FVPL_AMOUNT,
	CASE WHEN t4.FVPL_APP != 'Y' THEN 0 ELSE t2.RE_FVPL_AMOUNT END AS RE_FVPL_AMOUNT,
	CTE9.NON_CFC_DISPOSAL_ADJ,
	FLOOR(isnull(CTE9.ACCUMULATED_AMOUNT, 0) - isnull(CTE9.AMOUNT_TOTAL, 0) + isnull(t2.DESPITE_PROFIT, 0) -
	isnull(CTE9.REALIZED_LOSS, 0) + isnull(CTE9.DISTRI_NONCN, 0) + isnull(CTE9.DISTRI_CN, 0) - isnull(CASE WHEN t4.FVPL_APP != 'Y' THEN 0 ELSE t2.FVPL_FVCHANGE END, 0) + isnull(CASE WHEN t4.FVPL_APP != 'Y' THEN 0 ELSE t2.RE_FVPL_AMOUNT END, 0) + isnull(CASE WHEN t4.FVPL_APP != 'Y' THEN 0 ELSE t2.FVPL_AMOUNT END, 0) + isnull(CTE9.NON_CFC_DISPOSAL_ADJ, 0)) AS CFC_EARNINGS
	,t3.AVG_RATIO_HOLD
FROM CTE_EXEMPTION t1
LEFT JOIN CTE9 ON t1.INV_ENTITY_CODE = CTE9.CFC_ENTITY_CODE AND CTE9.PERIOD = t1.PERIOD AND t1.SCENARIO = CTE9.SCENARIO
LEFT JOIN CTE_OTHER_AMOUNT t2 ON t1.PERIOD = t2.PERIOD AND t1.INV_ENTITY_CODE = t2.INV_ENTITY_CODE AND t1.SCENARIO = t2.SCENARIO
LEFT JOIN CTE_RATIO_HOLD t3 ON t1.ENTITY_CODE = t3.ENTITY_CODE AND t1.PERIOD = t3.PERIOD AND t1.INV_ENTITY_CODE = t3.INV_ENTITY_CODE
LEFT JOIN CTE_FVPL t4 ON t4.PERIOD = FORMAT(t1.PERIOD, 'yyyy-MM') AND t1.ENTITY_CODE = t4.ENTITY_CODE;

-- dbo.V_TRS_FACT_CFC_APPROVAL source

CREATE VIEW V_TRS_FACT_CFC_APPROVAL ("ID", "YEAR", "ENTITY_CODE", "APPROVAL", "ATTACHMENT", "FILENAME", "SCENARIO") AS 
  SELECT 
	T1.ID,
	T1.YEAR,
	T2.CURRENT_CODE AS ENTITY_CODE ,
	T1.APPROVAL ,
	T1.ATTACHMENT ,
	T1.FILENAME ,
	T1.SCENARIO 
FROM TRS_FACT_CFC_APPROVAL T1
LEFT JOIN V_TRS_DIM_ENTITY_CUR T2 ON T1.ENTITY_CODE = T2.ENTITY_CODE;


-- dbo.V_TRS_FACT_CFC_APPROVAL_DETAIL source

CREATE VIEW V_TRS_FACT_CFC_APPROVAL_DETAIL ("ID", "YEAR", "ENTITY_CODE", "INV_ENTITY_CODE", "GAIN_LOSS", "SCENARIO", "AMOUNT") AS 
  SELECT 
	T1.ID,
	T1.YEAR,
	T2.CURRENT_CODE AS ENTITY_CODE ,
	T3.CURRENT_CODE AS INV_ENTITY_CODE,
	T1.GAIN_LOSS  ,
	T1.SCENARIO  ,
	T1.AMOUNT 
FROM TRS_FACT_CFC_APPROVAL_DETAIL T1
LEFT JOIN V_TRS_DIM_ENTITY_CUR T2 ON T1.ENTITY_CODE = T2.ENTITY_CODE
LEFT JOIN V_TRS_DIM_ENTITY_CUR T3 ON T1.INV_ENTITY_CODE = T3.ENTITY_CODE;

-- dbo.V_TRS_FACT_CFC_10Y_LOSS_DEDUCTED source

CREATE VIEW V_TRS_FACT_CFC_10Y_LOSS_DEDUCTED("PERIOD", "YYYY", "SCENARIO", "ENTITY_CODE", "CFC_ENTITY_CODE", "EARNINGS_TAX", "LOSS_TAX", "EARNINGS_ASSESSMENT", "LOSS_ASSESSMENT", "APPROVAL") AS 
WITH CTE_INCOME AS(
 SELECT 
	t1.PERIOD,
	t1.SCENARIO,
	t1.ENTITY_CODE,
	t1.INV_ENTITY_CODE AS CFC_ENTITY_CODE,
	CASE WHEN t1.CFC_EARNINGS >= 0 THEN t1.CFC_EARNINGS ELSE NULL END AS EARNINGS_TAX,
	CASE WHEN t1.CFC_EARNINGS < 0 THEN t1.CFC_EARNINGS * -1 ELSE NULL END AS LOSS_TAX,
	CASE WHEN GAIN_LOSS = 'EARN' THEN t2.AMOUNT ELSE NULL END AS EARNINGS_ASSESSMENT,
	CASE WHEN GAIN_LOSS = 'LOSS' THEN t2.AMOUNT ELSE NULL END AS LOSS_ASSESSMENT,
	t3.APPROVAL
FROM V_TRS_FACT_CFC_TAX_INCOME t1 --申報數
LEFT JOIN V_TRS_FACT_CFC_APPROVAL_DETAIL t2 ON YEAR(t1.PERIOD) = t2.YEAR AND t1.SCENARIO = t2.SCENARIO AND t1.ENTITY_CODE = t2.ENTITY_CODE AND t1.INV_ENTITY_CODE = t2.INV_ENTITY_CODE
LEFT JOIN V_TRS_FACT_CFC_APPROVAL t3 ON t1.PERIOD = (t3.YEAR + '-12-31') AND t1.ENTITY_CODE = t3.ENTITY_CODE AND t1.SCENARIO = t3.SCENARIO
)
,CTE_PERIOD AS(
SELECT
	PERIOD
FROM TRS_FACT_CFC_ENTITY_VERSION_PERIOD
WHERE YEAR(PERIOD) >= '2023'
),CTE_VERSION AS (
SELECT  
	SCENARIO
FROM TRS_FACT_CFC_ENTITY_VERSION_SCENARIO
),CTE_HEAD AS (
SELECT 
	PERIOD,
	SCENARIO
FROM TRS_FACT_CFC_ENTITY_VERSION_PERIOD_SCENARIO
),CTE0 AS (
SELECT
	t1.PERIOD,
	t2.SCENARIO,
	t1.ENTITY_CODE,
	CFC_ENTITY_CODE,
	EARNINGS_TAX,
	LOSS_TAX,
	EARNINGS_ASSESSMENT,
	LOSS_ASSESSMENT,
	APPROVAL
FROM CTE_INCOME t1
CROSS JOIN CTE_VERSION t2
WHERE t1.SCENARIO = 'Per Audit' AND MONTH(t1.PERIOD) = 12
)
SELECT
	t1.PERIOD,
	t2.PERIOD AS YYYY,
	t1.SCENARIO,
	t2.ENTITY_CODE,
	CFC_ENTITY_CODE,
	EARNINGS_TAX,
	LOSS_TAX,
	EARNINGS_ASSESSMENT,
	LOSS_ASSESSMENT,
	APPROVAL
FROM CTE_HEAD t1
JOIN CTE0 t2 ON t1.PERIOD > t2.PERIOD AND t1.SCENARIO  = t2.SCENARIO
UNION ALL
SELECT 
t1.PERIOD,
t2.PERIOD AS YYYY,
t2.SCENARIO,
t2.ENTITY_CODE,
CFC_ENTITY_CODE,
EARNINGS_TAX,
LOSS_TAX,
EARNINGS_ASSESSMENT,
LOSS_ASSESSMENT,
APPROVAL
FROM CTE_PERIOD t1
JOIN CTE_INCOME t2 ON t1.PERIOD = t2.PERIOD;



-- dbo.V_TRS_CFC_10Y_DEDUCTION_RESULT source

CREATE VIEW V_TRS_CFC_10Y_DEDUCTION_RESULT AS 
  WITH CTE_PAST AS (
SELECT
	SUM(DEDUCTION) AS PAST_DEDUCTION,
	SCENARIO,
	ENTITY_CODE,
	CFC_ENTITY_CODE,
	PERIOD,
	FISCAL_YEAR,
	CATEGORY
FROM V_TRS_CFC_10Y_DEDUCTION_DETAIL
WHERE YEAR(PERIOD) > YEAR(DEDUCTED_YEAR)
GROUP BY PERIOD, SCENARIO, ENTITY_CODE, CFC_ENTITY_CODE, FISCAL_YEAR, CATEGORY
),CTE_THIS_YEAR AS(
SELECT
	SUM(DEDUCTION) AS THIS_DEDUCTION,
	SCENARIO,
	ENTITY_CODE,
	CFC_ENTITY_CODE,
	PERIOD,
	FISCAL_YEAR,
	CATEGORY
FROM V_TRS_CFC_10Y_DEDUCTION_DETAIL
WHERE YEAR(PERIOD) = YEAR(DEDUCTED_YEAR)
GROUP BY PERIOD, SCENARIO, ENTITY_CODE, CFC_ENTITY_CODE, FISCAL_YEAR, CATEGORY
)
SELECT
	t1.PERIOD,
	t1.YYYY,
	t1.SCENARIO,
	t1.ENTITY_CODE,
	t1.CFC_ENTITY_CODE,
	t1.EARNINGS_TAX,
	t1.LOSS_TAX,
	t1.EARNINGS_ASSESSMENT,
	t1.LOSS_ASSESSMENT,
	t1.APPROVAL,
	CASE WHEN t3.CATEGORY IS NOT NULL THEN t3.CATEGORY ELSE t2.CATEGORY END AS CATEGORY,
	t2.PAST_DEDUCTION,
	t3.THIS_DEDUCTION
FROM V_TRS_FACT_CFC_10Y_LOSS_DEDUCTED t1
LEFT JOIN CTE_PAST t2 ON t1.ENTITY_CODE = t2.ENTITY_CODE AND t1.CFC_ENTITY_CODE = t2.CFC_ENTITY_CODE AND t1.PERIOD = t2.PERIOD AND t1.SCENARIO = t2.SCENARIO AND t1.YYYY = t2.FISCAL_YEAR
LEFT JOIN CTE_THIS_YEAR t3 ON t1.ENTITY_CODE = t3.ENTITY_CODE AND t1.CFC_ENTITY_CODE = t3.CFC_ENTITY_CODE AND t1.PERIOD = t3.PERIOD AND t1.SCENARIO = t3.SCENARIO AND t1.YYYY = t3.FISCAL_YEAR;

-- dbo.V_TRS_DIM_COMPANY source

CREATE VIEW V_TRS_DIM_COMPANY AS
WITH CTE AS(
SELECT 
COMPANY_ID ,
COMPANY_ID AS CODE,
PRE_CODE,
IS_ACTIVE
FROM TRS_DIM_COMPANY 
UNION ALL
SELECT
c.COMPANY_ID,
t.COMPANY_ID AS CODE,
t.PRE_CODE,
t.IS_ACTIVE
FROM CTE c
JOIN TRS_DIM_COMPANY t ON c.CODE = t.PRE_CODE
)
  SELECT 
	t1.COMPANY_ID ,
	t1.COMPANY_CODE ,
	t1.PRE_CODE ,
	t4.CODE AS CURRENT_CODE,
	t1.COMPANY_DISPLAY,
	t1.BUSINESS_TYPE ,
	t1.INDUSTRY ,
	t1.BUSINESS_STATUS ,
	t1.START_DATE ,
	t1.CANCELLATION_DATE ,
	t1.COUNTRY_ID ,
	t1.REGION_ID ,
	t1.LEGAL_REPRESENTATIVE ,
	t1.CONTACT_NUMBER ,
	t1.REGISTRATION_DATE ,
	t1.LOCAL_CURRENCY_ID ,
	t1.IS_ACTIVE ,
	t1.CREATED_BY ,
	t1.CREATED_TIME ,
	t1.UPDATED_BY ,
	t1.UPDATED_TIME ,
	t2.ID ,
	t2.ADDRESS ,
	t2.REGISTRATION_ADDRESS ,
	t2.COMPANY_NAME ,
	t2."LANGUAGE" ,
    t3.FR_LOCALE 
FROM 
    TRS_DIM_COMPANY t1
    JOIN TRS_DIM_SYSTEM_LANG t3  ON t3.IS_ACTIVE ='true'
    LEFT JOIN TRS_DIM_COMPANY_I18N  t2  ON t1.COMPANY_ID  = t2.COMPANY_ID  AND t2."LANGUAGE" = t3.FR_LOCALE
    LEFT JOIN CTE t4 ON t1.COMPANY_CODE = t4.COMPANY_ID AND t4.IS_ACTIVE ='true';
-- dbo.V_TRS_DIM_ENTITY source

CREATE VIEW V_TRS_DIM_ENTITY AS
WITH CTE AS(
SELECT 
ENTITY_ID ,
ENTITY_ID AS CODE,
PRE_CODE,
IS_ACTIVE
FROM TRS_DIM_ENTITY 
UNION ALL
SELECT
c.ENTITY_ID,
t.ENTITY_ID AS CODE,
t.PRE_CODE,
t.IS_ACTIVE
FROM CTE c
JOIN TRS_DIM_ENTITY t ON c.CODE = t.PRE_CODE
)
SELECT
	t1.ENTITY_ID ,
	t1.COMPANY_ID ,
	t1.ENTITY_CODE ,
	t1.PRE_CODE ,
	t4.CODE AS CURRENT_CODE,
	t1.ENTITY_DISPLAY,
	t1.ENTITY_TYPE_ID ,
	t1.COUNTRY_ID ,
	t1.REGION_ID ,
	t1.CURRENCY_ID ,
	t1.SALES_FUNCTION_ID ,
	t1.PLI ,
	t1.IS_ACTIVE ,
	t1.CREATED_BY ,
	t1.CREATED_TIME ,
	t1.UPDATED_BY ,
	t1.UPDATED_TIME ,
	t2.ENTITY_NAME ,
	t2.ID ,
	t2."LANGUAGE" ,
    t3.FR_LOCALE  
 FROM 
    TRS_DIM_ENTITY t1
    JOIN TRS_DIM_SYSTEM_LANG t3  ON t3.IS_ACTIVE ='true'
    LEFT JOIN TRS_DIM_ENTITY_I18N t2  ON t1.ENTITY_ID  = t2.ENTITY_ID  AND t2."LANGUAGE" = t3.FR_LOCALE
    LEFT JOIN CTE t4 ON t1.ENTITY_CODE = t4.ENTITY_ID AND t4.IS_ACTIVE = 'true';


-- dbo.V_TRS_DIM_ENTITY_TYPE source

CREATE   VIEW V_TRS_DIM_ENTITY_TYPE ([ENTITY_TYPE_ID], [KEY_NAME], [ID], [ENTITY_TYPE_NAME], [CREATED_BY], [CREATED_TIME], [UPDATED_BY], [UPDATED_TIME], [LANGUAGE], [FR_LOCALE]) AS 
  SELECT 
    t1.entity_type_ID ,
	t1.key_name ,
	t2.ID,
	t2.entity_type_NAME,
    t2.CREATED_BY ,
    t2.CREATED_TIME ,
    t2.UPDATED_BY ,
    t2.UPDATED_TIME ,
    t2.LANGUAGE,
    t3.FR_LOCALE 
FROM 
    TRS_DIM_entity_type t1
    JOIN TRS_DIM_SYSTEM_LANG t3  ON t3.IS_ACTIVE ='true'
    LEFT JOIN TRS_DIM_entity_type_I18N t2  ON t1.entity_type_ID  = t2.entity_type_ID  AND t2.[LANGUAGE] = t3.FR_LOCALE;



-- dbo.V_TRS_DATA_AUTHORIZATION source

CREATE   VIEW V_TRS_DATA_AUTHORIZATION 
("USERNAME", "REALNAME", "COMPANY_DISPLAY", "COMP_ID", "ENTITY_DISPLAY", "ENT_ID", "POSITION_DISPLAY", "MODULE") 
AS 
WITH DEPARTMENT AS (
    SELECT
        t1.id,
        t3.name AS company_display,
        t2.name AS entity_display,
        t1.name AS module_display
    FROM FINEDB11.dbo.fine_department t1
    JOIN FINEDB11.dbo.fine_department t2 ON t1.parentId = t2.id
    JOIN FINEDB11.dbo.fine_department t3 ON t2.parentId = t3.id
)
SELECT DISTINCT 
    t1.userName,
    t1.realName,
    t5.company_display,
    t6.company_id AS comp_id,
    t5.entity_display,
    t8.ENTITY_ID AS ent_id,
    t4.name AS position_display,
    t5.module_display AS module
FROM FINEDB11.dbo.fine_user t1
LEFT JOIN FINEDB11.dbo.fine_user_role_middle t2 ON t1.id = t2.userId
LEFT JOIN FINEDB11.dbo.fine_dep_role t3 ON t2.roleId = t3.id
LEFT JOIN FINEDB11.dbo.fine_post t4 ON t3.postId = t4.id
LEFT JOIN DEPARTMENT t5 ON t3.departmentId = t5.id
LEFT JOIN v_trs_dim_company t6 ON t6.company_display COLLATE Chinese_PRC_CI_AS = t5.company_display AND t6.IS_ACTIVE = 'true'
LEFT JOIN v_trs_dim_entity t7 ON t7.entity_display COLLATE Chinese_PRC_CI_AS= t5.entity_display 
    AND t6.company_id = t7.company_id 
    AND t7.LANGUAGE = t6.LANGUAGE 
    AND t7.IS_ACTIVE = 'true'
LEFT JOIN v_trs_dim_entity t8 ON t7.entity_code = t8.current_code 
    AND t7.LANGUAGE = t8.LANGUAGE 
WHERE t2.roleType = 1;


-- dbo.V_TRS_DATA_COUNTRY_REPORT source

-- dbo.V_TRS_DATA_COUNTRY_REPORT source

CREATE   VIEW [V_TRS_DATA_COUNTRY_REPORT] ([ID], [PERIOD], [ENTITY_ID], [DATA_NAME], [VALUE], [UNIT], [SOURCE], [MEMO], [CREATED_BY], [CREATED_TIME], [UPDATED_BY], [UPDATED_TIME]) AS 
WITH COUNTRY_REPORT AS (
    SELECT 
        ID, 
        -- 对 PERIOD 进行日期格式转换，如果 PERIOD 为空，则默认值为 '9999-12-31'
        CONVERT(DATE, ISNULL(PERIOD, '9999') + '-31') AS PERIOD, 
        ENTITY_ID, 
        DATA_NAME, 
        -- 将 VALUE 转换为 FLOAT 类型，如果转换失败，则忽略该行
        TRY_CAST(VALUE AS FLOAT) AS VALUE, 
        CREATED_BY, 
        CREATED_TIME, 
        UPDATED_BY, 
        UPDATED_TIME
    FROM 
        TRS_FACT_COUNTRY_REPORT
    WHERE 
        -- 使用 ISNUMERIC 来判断 VALUE 是否为数字
        ISNUMERIC(VALUE) = 1
)
SELECT 
    ID, 
    PERIOD, 
    ENTITY_ID, 
    DATA_NAME, 
    VALUE,
    NULL AS UNIT,
    -- 设置固定的 SOURCE 值
    'TRS_FACT_COUNTRY_REPORT' AS [SOURCE], 
    NULL AS MEMO, 
    CREATED_BY, 
    CREATED_TIME, 
    UPDATED_BY, 
    UPDATED_TIME
FROM 
    COUNTRY_REPORT;
-- dbo.V_TRS_DIM_COUNTRY source

CREATE VIEW V_TRS_DIM_COUNTRY ("COUNTRY_ID", "COUNTRY_CODE", "COUNTRY_DISPLAY", "DEFAULT_CURRENCY_ID", "ID", "COUNTRY_NAME", "CREATED_BY", "CREATED_TIME", "UPDATED_BY", "UPDATED_TIME", "LANGUAGE", "FR_LOCALE") AS 
  SELECT 
    t1.COUNTRY_ID ,
    t1.COUNTRY_CODE  ,
    t1.COUNTRY_DISPLAY,
    t1.DEFAULT_CURRENCY_ID ,
    t2.ID ,
    t2.COUNTRY_NAME ,
    t2.CREATED_BY ,
    t2.CREATED_TIME ,
    t2.UPDATED_BY ,
    t2.UPDATED_TIME ,
    t2.LANGUAGE,
    t3.FR_LOCALE 
FROM 
    TRS_DIM_COUNTRY t1
    JOIN TRS_DIM_SYSTEM_LANG t3  ON t3.IS_ACTIVE ='true'
    LEFT JOIN TRS_DIM_COUNTRY_I18N t2  ON t1.COUNTRY_ID  = t2.COUNTRY_ID  AND t2."LANGUAGE" = t3.FR_LOCALE 	;

-- dbo.V_TRS_FACT_COUNTRY_TAX source

CREATE VIEW V_TRS_FACT_COUNTRY_TAX ("COUNTRY_CODE", "COUNTRY_TAX_ID", "TAX_RATE", "START_DATE", "END_DATE", "CREATED_BY", "CREATED_TIME", "UPDATED_BY", "UPDATED_TIME", "IS_LOWTAX") AS 
  SELECT DISTINCT t1.COUNTRY_CODE,
t2.COUNTRY_TAX_ID ,
t2.TAX_RATE ,
t2.START_DATE ,
t2.END_DATE ,
t2.CREATED_BY ,
t2.CREATED_TIME ,
t2.UPDATED_BY ,
t2.UPDATED_TIME ,
t2.IS_LOWTAX 
FROM V_TRS_DIM_COUNTRY t1
LEFT JOIN TRS_FACT_COUNTRY_TAX t2
ON t1.COUNTRY_CODE = t2.COUNTRY_CODE 
;

-- dbo.V_TRS_DATA_COUNTRY_TAX_RESULT source

CREATE   VIEW [V_TRS_DATA_COUNTRY_TAX_RESULT] 
AS
WITH COUNTRY_TAX_GEN_YEAR AS (
    -- 生成前5年、今年及未来1年
    SELECT YEAR(GETDATE()) - 4 AS PERIOD
    UNION ALL
    SELECT PERIOD 
    FROM (
        SELECT YEAR(GETDATE()) - 3 AS PERIOD
        UNION ALL
        SELECT YEAR(GETDATE()) - 2
        UNION ALL
        SELECT YEAR(GETDATE()) - 1
        UNION ALL
        SELECT YEAR(GETDATE())
        UNION ALL
        SELECT YEAR(GETDATE()) + 1
    ) AS Years
), 
COUNTRY_TAX_TIME AS (
    SELECT 
        CASE 
            WHEN YEAR(t.START_DATE) <= g.PERIOD 
                 AND YEAR(t.END_DATE) >= g.PERIOD 
            THEN DATEFROMPARTS(g.PERIOD, 12, 31) 
        END AS PERIOD,
        t.COUNTRY_CODE,
        t.START_DATE,
        t.END_DATE,
        t.IS_LOWTAX,
        t.TAX_RATE
    FROM 
        V_TRS_FACT_COUNTRY_TAX t,COUNTRY_TAX_GEN_YEAR g 
    WHERE 
        g.PERIOD > 2000
), 
COUNTRY_TAX_CR AS (
    SELECT *
    FROM COUNTRY_TAX_TIME
    WHERE PERIOD IS NOT NULL
), 
COUNTRY_TAX_RESULT AS (
    SELECT 
        t.PERIOD,
        e.ENTITY_ID,
        CASE 
            WHEN t.IS_LOWTAX = 'true' THEN 1 
            ELSE 0 
        END AS IS_LOWTAX,
        t.TAX_RATE
    FROM 
        TRS_DIM_ENTITY e
    LEFT JOIN 
        TRS_DIM_COUNTRY c ON e.COUNTRY_ID = c.COUNTRY_ID
    LEFT JOIN 
        COUNTRY_TAX_CR t ON c.COUNTRY_CODE = t.COUNTRY_CODE
)
-- 汇总最终结果集
SELECT 
    NULL AS ID,
    PERIOD,
    ENTITY_ID,
    '是否為低稅地區' AS DATA_NAME,
    IS_LOWTAX AS VALUE,
    NULL AS UNIT,
    'TRS_FACT_COUNTRY_TAX' AS [SOURCE],
    NULL AS MEMO,
    NULL AS CREATED_BY,
    NULL AS CREATED_TIME,
    NULL AS UPDATED_BY,
    NULL AS UPDATED_TIME 
FROM 
    COUNTRY_TAX_RESULT

UNION ALL

SELECT 
    NULL AS ID,
    PERIOD,
    ENTITY_ID,
    '有效稅率' AS DATA_NAME,
    TAX_RATE AS VALUE,
    NULL AS UNIT,
    'TRS_FACT_COUNTRY_TAX' AS [SOURCE],
    NULL AS MEMO,
    NULL AS CREATED_BY,
    NULL AS CREATED_TIME,
    NULL AS UPDATED_BY,
    NULL AS UPDATED_TIME 
FROM 
    COUNTRY_TAX_RESULT;


-- dbo.V_TRS_DIM_ACCOUNT source

-- dbo.V_TRS_DIM_ACCOUNT source

-- dbo.V_TRS_DIM_ACCOUNT source

-- TRSDB.V_TRS_DIM_ACCOUNT source

CREATE VIEW V_TRS_DIM_ACCOUNT
("ACCOUNT_ID", "ACCOUNT_CODE", "PARENT_CODE", "IFRS_VERSION", "DEBIT_CREDIT", "CREATED_BY", "CREATED_TIME", "UPDATED_BY", "UPDATED_TIME", "ACCOUNT_NAME", "ID", "LANGUAGE", "FR_LOCALE") 
AS SELECT
	t1.ACCOUNT_ID ,
	t1.ACCOUNT_CODE ,
	t1.PARENT_CODE ,
	t1.IFRS_VERSION ,
	t1.DEBIT_CREDIT ,
	t1.CREATED_BY ,
	t1.CREATED_TIME ,
	t1.UPDATED_BY ,
	t1.UPDATED_TIME ,
	t2.ACCOUNT_NAME ,
	t2.ID ,
	t2."LANGUAGE" ,
    t3.FR_LOCALE 
FROM 
    dbo.TRS_DIM_ACCOUNT t1
    JOIN dbo.TRS_DIM_SYSTEM_LANG t3  ON 1=1
    LEFT JOIN dbo.TRS_DIM_ACCOUNT_I18N t2  ON t1.ACCOUNT_ID  = t2.ACCOUNT_ID  AND t2."LANGUAGE" = t3.FR_LOCALE 	
;


-- dbo.V_TRS_DIM_ACCOUNTING_RANKING source

-- dbo.V_TRS_DIM_ACCOUNTING_RANKING source

CREATE VIEW dbo.V_TRS_DIM_ACCOUNTING_RANKING
AS
WITH ACCOUNT AS (
    SELECT
        account_code,
        parent_code,
        account_name,
        DEBIT_CREDIT,
        IFRS_VERSION,
        language
    FROM dbo.V_TRS_DIM_ACCOUNT -- Use fully qualified name
    WHERE 1=1
)
SELECT 
    t1.ACCOUNT_CODE AS T1_CODE,
    t1.account_name AS T1_NAME,
    t2.ACCOUNT_CODE AS T2_CODE,
    t2.account_name AS T2_NAME,
    t2.debit_credit AS T2_DEBIT_CREDIT,
    t3.ACCOUNT_CODE AS T3_CODE,
    t3.account_name AS T3_NAME,
    t3.debit_credit AS T3_DEBIT_CREDIT,
    t4.ACCOUNT_CODE AS T4_CODE,
    t4.account_name AS T4_NAME,
    t4.debit_credit AS T4_DEBIT_CREDIT,
    t5.ACCOUNT_CODE AS T5_CODE,
    t5.account_name AS T5_NAME,
    t5.debit_credit AS T5_DEBIT_CREDIT,
    t6.ACCOUNT_CODE AS T6_CODE,
    t6.account_name AS T6_NAME,
    t6.debit_credit AS T6_DEBIT_CREDIT,
    t7.ACCOUNT_CODE AS T7_CODE,
    t7.account_name AS T7_NAME,
    t7.debit_credit AS T7_DEBIT_CREDIT,
    t1.IFRS_VERSION,
    t1.language 
FROM ACCOUNT t1
LEFT JOIN ACCOUNT t2 ON t1.ACCOUNT_CODE = t2.parent_code AND t1.language = t2.language AND t1.IFRS_VERSION = t2.IFRS_VERSION
LEFT JOIN ACCOUNT t3 ON t2.ACCOUNT_CODE = t3.parent_code AND t2.language = t3.language AND t2.IFRS_VERSION = t3.IFRS_VERSION
LEFT JOIN ACCOUNT t4 ON t3.ACCOUNT_CODE = t4.parent_code AND t3.language = t4.language AND t3.IFRS_VERSION = t4.IFRS_VERSION
LEFT JOIN ACCOUNT t5 ON t4.ACCOUNT_CODE = t5.parent_code AND t4.language = t5.language AND t4.IFRS_VERSION = t5.IFRS_VERSION
LEFT JOIN ACCOUNT t6 ON t5.ACCOUNT_CODE = t6.parent_code AND t5.language = t6.language AND t5.IFRS_VERSION = t6.IFRS_VERSION
LEFT JOIN ACCOUNT t7 ON t6.ACCOUNT_CODE = t7.parent_code AND t6.language = t7.language AND t6.IFRS_VERSION = t7.IFRS_VERSION
WHERE 1=1 
AND t1.ACCOUNT_CODE IN ('BS','PL')
AND t1.LANGUAGE IS NOT NULL;




-- dbo.V_TRS_DIM_COMPANY_CUR source

CREATE VIEW V_TRS_DIM_COMPANY_CUR AS
WITH CTE AS(
SELECT 
COMPANY_ID ,
COMPANY_ID AS CODE,
PRE_CODE,
IS_ACTIVE
FROM TRS_DIM_COMPANY 
UNION ALL
SELECT
c.COMPANY_ID,
t.COMPANY_ID AS CODE,
t.PRE_CODE,
t.IS_ACTIVE
FROM CTE c
JOIN TRS_DIM_COMPANY t ON c.CODE = t.PRE_CODE
)
SELECT t1.COMPANY_CODE,
ISNULL(c.CODE,t1.COMPANY_CODE) AS CURRENT_CODE,
t1.COUNTRY_ID,
t1.LOCAL_CURRENCY_ID,
t1.IS_ACTIVE,
CASE WHEN t1.COMPANY_CODE = ISNULL(c.CODE,t1.COMPANY_CODE) THEN 'true'
ELSE t1.IS_ACTIVE END AS SHOW
FROM TRS_DIM_COMPANY t1
LEFT JOIN CTE c ON c.IS_ACTIVE = 'true' AND t1.COMPANY_CODE = c.COMPANY_ID;




-- dbo.V_TRS_DIM_CURRENCY source

CREATE VIEW V_TRS_DIM_CURRENCY ("CURRENCY_ID", "CURRENCY_CODE", "ID", "CURRENCY_NAME", "CREATED_BY", "CREATED_TIME", "UPDATED_BY", "UPDATED_TIME", "LANGUAGE", "FR_LOCALE") AS 
  SELECT 
    t1.CURRENCY_ID ,
	t1.CURRENCY_code,
    t2.ID,
	t2.CURRENCY_NAME,
    t2.CREATED_BY ,
    t2.CREATED_TIME ,
    t2.UPDATED_BY ,
    t2.UPDATED_TIME ,
    t2.LANGUAGE,
    t3.FR_LOCALE 
FROM 
    TRS_DIM_CURRENCY t1
    JOIN TRS_DIM_SYSTEM_LANG t3  ON t3.IS_ACTIVE ='true'
    LEFT JOIN TRS_DIM_CURRENCY_I18N t2  ON t1.CURRENCY_ID  = t2.CURRENCY_ID  AND t2."LANGUAGE" = t3.FR_LOCALE;


-- dbo.V_TRS_DIM_DEFAULT_TASK source

CREATE VIEW V_TRS_DIM_DEFAULT_TASK ("DEFAULT_TASK_ID", "TASK_CATEGORY_ID", "TASK_NAME_ID", "MODULE_ID", "TASK_RESULT_ID", "VALUE_TYPE_ID", "CREATED_BY", "CREATED_TIME", "UPDATED_BY", "UPDATED_TIME") AS 
  SELECT 
	t1.default_task_id ,
	t1.task_category_id ,
	t1.task_name_id,
	t1.module_id,
	t2.task_result_id,
	t2.value_type_id,
	t2.created_by,
	t2.created_time,
	t2.updated_by,
	t2.updated_time
FROM 
	TRS_FACT_DEFAULT_TASK t1 
	JOIN TRS_DIM_TASK_VALUE t2 ON  t1.default_task_id = t2.task_id;



-- dbo.V_TRS_DIM_INV_ADJITEM source

CREATE VIEW V_TRS_DIM_INV_ADJITEM AS
  SELECT 
    t1.SERIAL_NO,
	t1.INV_ADJITEM_ID ,
	t1.INV_ADJITEM_code,
	t1.ADD_LESS,
	t1.AUTO_CAL,
    t2.ID,
	t2.INV_ADJITEM_NAME,
    t2.CREATED_BY ,
    t2.CREATED_TIME ,
    t2.UPDATED_BY ,
    t2.UPDATED_TIME ,
    t2.LANGUAGE,
    t3.FR_LOCALE 
FROM 
    TRS_DIM_INV_ADJITEM t1
    JOIN TRS_DIM_SYSTEM_LANG t3  ON t3.IS_ACTIVE ='true'
    LEFT JOIN TRS_DIM_INV_ADJITEM_I18N t2  ON t1.INV_ADJITEM_ID  = t2.INV_ADJITEM_ID  AND t2."LANGUAGE" = t3.FR_LOCALE;


-- dbo.V_TRS_DIM_REGION source

CREATE VIEW V_TRS_DIM_REGION ("REGION_ID", "REGION_CODE", "COUNTRY_ID", "ID", "REGION_NAME", "CREATED_BY", "CREATED_TIME", "UPDATED_BY", "UPDATED_TIME", "LANGUAGE", "FR_LOCALE") AS 
  SELECT 
    t1.REGION_ID ,
	t1.region_code,
    t1.COUNTRY_ID,
    t2.ID,

	t2.REGION_NAME,
    t2.CREATED_BY ,
    t2.CREATED_TIME ,
    t2.UPDATED_BY ,
    t2.UPDATED_TIME ,
    t2.LANGUAGE,
    t3.FR_LOCALE 
FROM 
    TRS_DIM_REGION t1
    JOIN TRS_DIM_SYSTEM_LANG t3  ON t3.IS_ACTIVE ='true'
    LEFT JOIN TRS_DIM_REGION_I18N t2  ON t1.REGION_ID  = t2.REGION_ID  AND t2."LANGUAGE" = t3.FR_LOCALE 		
	
	
;


-- dbo.V_TRS_DIM_RISK_INDICATOR source

CREATE VIEW V_TRS_DIM_RISK_INDICATOR ("RISK_INDICATOR_ID", "ENTITY_TYPE_ID", "TASK_FREQUENCY_ID", "CREATED_BY", "CREATED_TIME", "UPDATED_BY", "UPDATED_TIME", "LINK", "ID", "RISK_INDICATOR_NAME", "FUNCTION", "SCENARIO", "RISK_INDICATOR_CATEGORY", "DESCRIPTION", "IS_CONDITION", "LANGUAGE", "FR_LOCALE") AS 
  SELECT 
	t1.RISK_INDICATOR_ID ,
	t1.ENTITY_TYPE_ID ,
	t1.TASK_FREQUENCY_ID ,
	t1.CREATED_BY ,
	t1.CREATED_TIME ,
	t1.UPDATED_BY ,
	t1.UPDATED_TIME ,
	t1.link,
	t2.ID ,
	t2.RISK_INDICATOR_NAME ,
	t2."FUNCTION" ,
	t2.SCENARIO ,
	t2.RISK_INDICATOR_CATEGORY ,
	t2.DESCRIPTION ,
	t1.IS_CONDITION ,
	t2."LANGUAGE" ,
    t3.FR_LOCALE 
FROM 
    TRS_DIM_RISK_INDICATOR t1
    JOIN TRS_DIM_SYSTEM_LANG t3  ON t3.IS_ACTIVE = 'true'
    LEFT JOIN TRS_DIM_RISK_INDICATOR_I18N t2  ON t1.RISK_INDICATOR_ID  = t2.RISK_INDICATOR_ID  AND t2."LANGUAGE" = t3.FR_LOCALE;


-- dbo.V_TRS_DIM_SALES_FUNCTION source

-- TRSDB.V_TRS_DIM_SALES_FUNCTION source

CREATE VIEW V_TRS_DIM_SALES_FUNCTION("SALES_FUNCTION_ID", "KEY_NAME", "ID", "SALES_FUNCTION_NAME", "CREATED_BY", "CREATED_TIME", "UPDATED_BY", "UPDATED_TIME", "LANGUAGE", "FR_LOCALE") AS 
  SELECT 
    t1.SALES_FUNCTION_ID ,
	t1.KEY_NAME ,
	t2.ID,
	t2.SALES_FUNCTION_NAME,
    t2.CREATED_BY ,
    t2.CREATED_TIME ,
    t2.UPDATED_BY ,
    t2.UPDATED_TIME ,
    t2.LANGUAGE,
    t3.FR_LOCALE 
FROM 
    TRS_DIM_SALES_FUNCTION t1
    JOIN TRS_DIM_SYSTEM_LANG t3  ON t3.IS_ACTIVE ='true'
    LEFT JOIN TRS_DIM_SALES_FUNCTION_I18N t2  ON t1.SALES_FUNCTION_ID  = t2.SALES_FUNCTION_ID  AND t2."LANGUAGE" = t3.FR_LOCALE;


-- dbo.V_TRS_DIM_STATUS source

CREATE VIEW V_TRS_DIM_STATUS ("CODE_ID", "STATUS_ID", "STATUS_CODE", "STATUS_KEY", "MODULE_ID", "STATUS_DESCRIPTION", "CREATED_BY", "CREATED_TIME", "UPDATED_BY", "UPDATED_TIME", "STATUS_NAME", "ID", "LANGUAGE", "FR_LOCALE") AS 
  SELECT
  	t1.ID AS CODE_ID,
	t1.STATUS_ID ,
	t1.STATUS_CODE ,
	t1.STATUS_KEY ,
	t1.MODULE_ID ,
	t1.STATUS_DESCRIPTION ,
	t1.CREATED_BY ,
	t1.CREATED_TIME ,
	t1.UPDATED_BY ,
	t1.UPDATED_TIME ,
	t2.STATUS_NAME ,
	t2.ID ,
	t2."LANGUAGE" ,
    t3.FR_LOCALE 
FROM 
    TRS_DIM_STATUS t1
    JOIN TRS_DIM_SYSTEM_LANG t3  ON t3.IS_ACTIVE ='true'
    LEFT JOIN TRS_DIM_STATUS_I18N t2  ON t1.STATUS_ID  = t2.STATUS_ID  AND t2."LANGUAGE" = t3.FR_LOCALE ;


-- dbo.V_TRS_DIM_TAG source

CREATE VIEW V_TRS_DIM_TAG ("TAG_ID", "TAG_KEY", "MODULE_ID", "TAG_DESCRIPTION", "CREATED_BY", "CREATED_TIME", "UPDATED_BY", "UPDATED_TIME", "TAG_NAME", "ID", "LANGUAGE", "FR_LOCALE") AS 
  SELECT
	t1.TAG_ID ,
	t1.TAG_KEY ,
	t1.MODULE_ID ,
	t1.TAG_DESCRIPTION ,
	t1.CREATED_BY ,
	t1.CREATED_TIME ,
	t1.UPDATED_BY ,
	t1.UPDATED_TIME ,
	t2.TAG_NAME ,
	t2.ID ,
	t2."LANGUAGE" ,
    t3.FR_LOCALE 
FROM 
    TRS_DIM_TAG t1
    JOIN TRS_DIM_SYSTEM_LANG t3  ON t3.IS_ACTIVE ='true'
    LEFT JOIN TRS_DIM_TAG_I18N t2  ON t1.TAG_ID  = t2.TAG_ID  AND t2."LANGUAGE" = t3.FR_LOCALE;


-- dbo.V_TRS_DIM_TASK_CATEGORY source

CREATE VIEW V_TRS_DIM_TASK_CATEGORY ("TASK_CATEGORY_ID", "KEY_NAME", "ID", "TASK_CATEGORY_NAME", "CREATED_BY", "CREATED_TIME", "UPDATED_BY", "UPDATED_TIME", "LANGUAGE", "FR_LOCALE") AS 
  SELECT 
    t1.TASK_CATEGORY_ID ,
	t1.KEY_NAME ,
    t2.ID,
	t2.TASK_CATEGORY_NAME,
    t2.CREATED_BY ,
    t2.CREATED_TIME ,
    t2.UPDATED_BY ,
    t2.UPDATED_TIME ,
    t2.LANGUAGE,
    t3.FR_LOCALE 
FROM 
    TRS_DIM_TASK_CATEGORY t1
    JOIN TRS_DIM_SYSTEM_LANG t3  ON t3.IS_ACTIVE ='true'
    LEFT JOIN TRS_DIM_TASK_CATEGORY_I18N t2  ON t1.TASK_CATEGORY_ID  = t2.TASK_CATEGORY_ID  AND t2."LANGUAGE" = t3.FR_LOCALE
    ;


-- dbo.V_TRS_DIM_TASK_FREQUENCY source

CREATE VIEW V_TRS_DIM_TASK_FREQUENCY ("TASK_FREQUENCY_ID", "FREQUENCY_CODE", "DATE_FORMAT", "PERIOD", "START_DATE", "END_DATE", "MONTH", "MEMO", "ID", "FREQUENCY_NAME", "CREATED_BY", "CREATED_TIME", "UPDATED_BY", "UPDATED_TIME", "LANGUAGE", "FR_LOCALE") AS 
  SELECT 
    t1.TASK_FREQUENCY_ID ,
	t1.FREQUENCY_CODE ,
	t1.date_format,
	t1.period,
	t1.start_date ,
	t1.end_date,
	t1.month,
	t1.memo,
	t2.ID,
	t2.FREQUENCY_NAME ,
    t2.CREATED_BY ,
    t2.CREATED_TIME ,
    t2.UPDATED_BY ,
    t2.UPDATED_TIME ,
    t2.LANGUAGE,
    t3.FR_LOCALE 
FROM 
    TRS_DIM_TASK_FREQUENCY t1
    JOIN TRS_DIM_SYSTEM_LANG t3  ON t3.IS_ACTIVE ='true'
    LEFT JOIN TRS_DIM_TASK_FREQUENCY_I18N t2  ON t1.TASK_FREQUENCY_ID  = t2.TASK_FREQUENCY_ID  AND t2."LANGUAGE" = t3.FR_LOCALE;


-- dbo.V_TRS_DIM_TASK_NAME source

CREATE VIEW V_TRS_DIM_TASK_NAME("TASK_NAME_ID", "KEY_NAME", "ID", "TASK_NAME", "CREATED_BY", "CREATED_TIME", "UPDATED_BY", "UPDATED_TIME", "LANGUAGE", "FR_LOCALE") AS 
  SELECT 
    t1.TASK_NAME_ID ,
	t1.KEY_NAME ,
    t2.ID,
	t2.TASK_NAME,
    t2.CREATED_BY ,
    t2.CREATED_TIME ,
    t2.UPDATED_BY ,
    t2.UPDATED_TIME ,
    t2.LANGUAGE,
    t3.FR_LOCALE 
FROM 
    TRS_DIM_TASK_NAME t1
    JOIN TRS_DIM_SYSTEM_LANG t3  ON t3.IS_ACTIVE ='true'
    LEFT JOIN TRS_DIM_TASK_NAME_I18N t2  ON t1.TASK_NAME_ID  = t2.TASK_NAME_ID  AND t2."LANGUAGE" = t3.FR_LOCALE
    ;


-- dbo.V_TRS_DIM_VALUE_TYPE source

-- TRSDB.V_TRS_DIM_VALUE_TYPE source

CREATE VIEW V_TRS_DIM_VALUE_TYPE ("VALUE_TYPE_ID", "KEY_NAME", "MODULE_ID", "MEMO", "ID", "VALUE_TYPE_NAME", "CREATED_BY", "CREATED_TIME", "UPDATED_BY", "UPDATED_TIME", "LANGUAGE", "FR_LOCALE") AS 
  SELECT 
    t1.VALUE_TYPE_ID ,
	t1.KEY_NAME ,
	t1.module_id,
    t1.memo,
	t2.ID,
	t2.VALUE_TYPE_NAME,
    t2.CREATED_BY ,
    t2.CREATED_TIME ,
    t2.UPDATED_BY ,
    t2.UPDATED_TIME ,
    t2.LANGUAGE,
    t3.FR_LOCALE 
FROM 
    TRS_DIM_VALUE_TYPE t1
    JOIN TRS_DIM_SYSTEM_LANG t3  ON t3.IS_ACTIVE ='true'
    LEFT JOIN TRS_DIM_VALUE_TYPE_I18N t2  ON t1.VALUE_TYPE_ID  = t2.VALUE_TYPE_ID  AND t2."LANGUAGE" = t3.FR_LOCALE;







-- dbo.V_TRS_FACT_CFC_ATTACHMENT source

CREATE VIEW V_TRS_FACT_CFC_ATTACHMENT AS
SELECT
	T1.ID,
	T1.PERIOD,
	T1.SCENARIO,
	T2.CURRENT_CODE AS ENTITY_CODE,
	T3.CURRENT_CODE AS INV_ENTITY_CODE,
	T1.ATTACHMENT ,
	T1.ATTCHMENT_TYPE ,
	T1.FILENAME ,
	T1.CREATED_BY ,
	T1.CREATED_TIME ,
	T1.UPDATED_BY ,
	T1.UPDATED_TIME 
FROM TRS_FACT_CFC_ATTACHMENT T1
LEFT JOIN V_TRS_DIM_ENTITY_CUR T2 ON T1.ENTITY_CODE = T2.ENTITY_CODE
LEFT JOIN V_TRS_DIM_ENTITY_CUR T3 ON T1.INV_ENTITY_CODE = T3.ENTITY_CODE;


-- dbo.V_TRS_FACT_CFC_DIVIDEND source

CREATE VIEW V_TRS_FACT_CFC_DIVIDEND AS
WITH CTE_PERIOD AS (
SELECT
	PERIOD,
	SCENARIO,
	ENTITY_CODE
FROM V_TRS_FACT_CFC_ENTITY_VERSION
),DIVIDEND AS(
SELECT
ID,
--ENTITY_CODE,
t2.CURRENT_CODE AS ENTITY_CODE,--用current_code輸出
--CFC_ENTITY_CODE,
t3.CURRENT_CODE AS CFC_ENTITY_CODE,--用current_code輸出
SCENARIO,
t1.CURRENCY_ID,
DECLARATION_DATE,
FISCAL_YEAR,
CHINA_DIVIDEND_PROFIT,
CHINA_PAID_TAX_NTD,
NON_CHINA_DIVIDEND_PROFIT ,
NON_CHINA_PAID_TAX,
CREATED_BY,
CREATED_TIME,
UPDATED_BY,
UPDATED_TIME,
EXCHANGE_RATE_DATE,
EXCHANGE_RATE_PAY
FROM TRS_FACT_CFC_DIVIDEND t1
LEFT JOIN V_TRS_DIM_ENTITY_CUR t2 ON t1.ENTITY_CODE = t2.ENTITY_CODE
LEFT JOIN V_TRS_DIM_ENTITY_CUR t3 ON t1.CFC_ENTITY_CODE = t3.ENTITY_CODE
),ORD AS(
SELECT
	T1.PERIOD,
	T1.SCENARIO,
	T2.CFC_ENTITY_CODE,
	T2.DECLARATION_DATE,
	T2.EXCHANGE_RATE_DATE,
	T2.EXCHANGE_RATE_PAY,
	RANK() OVER(PARTITION BY PERIOD, T2.SCENARIO, CFC_ENTITY_CODE ORDER BY DECLARATION_DATE DESC) AS RK
FROM CTE_PERIOD T1
JOIN DIVIDEND T2 ON T2.DECLARATION_DATE BETWEEN DATEFROMPARTS(YEAR(T1.PERIOD), 1, 1) AND T1.PERIOD AND T1.ENTITY_CODE = T2.CFC_ENTITY_CODE AND T1.SCENARIO = T2.SCENARIO
),CTE_LATEST_EXCHANGE AS (
SELECT
	PERIOD,
	SCENARIO,
	CFC_ENTITY_CODE,
	EXCHANGE_RATE_DATE,
	EXCHANGE_RATE_PAY
FROM ORD WHERE RK = 1
),GROUP_INV_REL AS(
SELECT 
--ENTITY_CODE,
t2.CURRENT_CODE AS ENTITY_CODE,--用current_code輸出
--INV_ENTITY_CODE,
t3.CURRENT_CODE AS INV_ENTITY_CODE,--用current_code輸出
START_DATE,
END_DATE,
RATIO_HOLD
FROM TRS_FACT_GROUP_INV_REL t1 
LEFT JOIN V_TRS_DIM_ENTITY_CUR t2 ON t1.ENTITY_CODE = t2.ENTITY_CODE
LEFT JOIN V_TRS_DIM_ENTITY_CUR t3 ON t1.INV_ENTITY_CODE = t3.ENTITY_CODE
)
SELECT
	t1.ID,
	t0.PERIOD,
	t1.ENTITY_CODE,
	t1.CFC_ENTITY_CODE,
	t0.SCENARIO,
	t1.CURRENCY_ID,
	t1.DECLARATION_DATE,
	t1.FISCAL_YEAR,
	t1.CHINA_DIVIDEND_PROFIT,
	t1.CHINA_PAID_TAX_NTD AS CHINA_PAID_TAX_NTD11,
	t1.NON_CHINA_DIVIDEND_PROFIT,
	t1.NON_CHINA_PAID_TAX,
	t2.RATIO_HOLD,
	CASE WHEN t1.FISCAL_YEAR = YEAR(t0.PERIOD) THEN t3.AVG_EXCHANGE_RATIO ELSE t5.AVG_EXCHANGE_RATIO END AS AVG_EXCHANGE_RATIO,
	t1.EXCHANGE_RATE_DATE,
	t1.EXCHANGE_RATE_PAY,
	t4.EXCHANGE_RATE_DATE AS L_EXCHANGE_RATE_DATE,
	t4.EXCHANGE_RATE_PAY AS L_EXCHANGE_RATE_PAY,
	FLOOR(ISNULL(t1.NON_CHINA_DIVIDEND_PROFIT, 0) * t2.RATIO_HOLD * CASE WHEN t1.FISCAL_YEAR = YEAR(t0.PERIOD) THEN t3.AVG_EXCHANGE_RATIO ELSE t5.AVG_EXCHANGE_RATIO END) AS NON_CHINA_DIVIDEND_PROFIT_NTD6,
	FLOOR(ISNULL(t1.NON_CHINA_PAID_TAX, 0) * t2.RATIO_HOLD * t1.EXCHANGE_RATE_PAY)AS NON_CHINA_PAID_TAX_NTD10,
	FLOOR(ISNULL(t1.CHINA_DIVIDEND_PROFIT, 0) * t2.RATIO_HOLD * CASE WHEN t1.FISCAL_YEAR = YEAR(t0.PERIOD) THEN t3.AVG_EXCHANGE_RATIO ELSE t5.AVG_EXCHANGE_RATIO END)AS CHINA_DIVIDEND_PROFIT_NTD7
FROM CTE_PERIOD t0
JOIN DIVIDEND t1 ON t1.DECLARATION_DATE BETWEEN DATEFROMPARTS(YEAR(T0.PERIOD), 1, 1) AND t0.PERIOD AND t0.ENTITY_CODE = t1.CFC_ENTITY_CODE AND t0.SCENARIO = t1.SCENARIO
LEFT JOIN GROUP_INV_REL t2 ON t1.CFC_ENTITY_CODE = t2.INV_ENTITY_CODE AND t1.ENTITY_CODE = t2.ENTITY_CODE AND t1.DECLARATION_DATE BETWEEN t2.START_DATE AND t2.END_DATE
LEFT JOIN V_TRS_FACT_EXCHANGE_BANKOFTW t3 ON t1.CURRENCY_ID = t3.CURRENCY_ID AND t3.TARGET_CURRENCY_ID = 'NTD' AND t1.SCENARIO = t3.SCENARIO AND FORMAT(t0.PERIOD, 'yyyy-MM') = t3.PERIOD
LEFT JOIN V_TRS_FACT_EXCHANGE_BANKOFTW t5 ON t1.CURRENCY_ID = t5.CURRENCY_ID AND t5.TARGET_CURRENCY_ID = 'NTD' AND t1.SCENARIO = t5.SCENARIO AND t1.FISCAL_YEAR + '-12' = t5.PERIOD
LEFT JOIN CTE_LATEST_EXCHANGE t4 ON t0.PERIOD = t4.PERIOD AND t0.SCENARIO = t4.SCENARIO AND t0.ENTITY_CODE = t4.CFC_ENTITY_CODE;









-- dbo.V_TRS_FACT_CFC_INV_INCOME source

-- dbo.V_TRS_FACT_CFC_INV_INCOME source

-- dbo.V_TRS_FACT_CFC_INV_INCOME source

-- dbo.V_TRS_FACT_CFC_INV_INCOME source

CREATE VIEW V_TRS_FACT_CFC_INV_INCOME AS 
WITH T_ORDER AS(
SELECT 
	ROW_NUMBER()OVER(PARTITION BY PERIOD, ENTITY_CODE,CFC_ENTITY_CODE,SCENARIO, FISCAL_YEAR ORDER BY PERIOD1) AS ORDERS,
	FISCAL_YEAR,
	PERIOD,
	PERIOD1,
	SCENARIO,
	ENTITY_CODE,
	CFC_ENTITY_CODE,
	AMOUNT,
	CHANGES,
	DATA_TYPE,
	CHINA
FROM TEMP_TRS_FACT_CFC_INV_INCOME2
)--SELECT * FROM T_ORDER WHERE TO_CHAR(PERIOD, 'YYYY-MM-DD') = '2024-06-30' AND SCENARIO = 'Per Audit' AND CFC_ENTITY_CODE = 'P00013_BVI' 
,DETAILS(ORDERS,FISCAL_YEAR,PERIOD,PERIOD1,SCENARIO,ENTITY_CODE,CFC_ENTITY_CODE,AMOUNT,CHANGES,AMOUNT_CHANGES,ACC_AMOUNT, DATA_TYPE, CHINA, E2) AS(
SELECT 
	ORDERS,
	FISCAL_YEAR,
	PERIOD,
	PERIOD1,
	SCENARIO,
	ENTITY_CODE,
	CFC_ENTITY_CODE,
	AMOUNT,
	CHANGES,
	ISNULL(CAST(AMOUNT AS FLOAT),0) AS AMOUNT_CHANGES,
	ISNULL(CAST(AMOUNT AS FLOAT),0) AS ACC_AMOUNT,
	DATA_TYPE,
	CHINA,
	CAST(AMOUNT AS FLOAT) AS E2
FROM T_ORDER
WHERE ORDERS = 1
UNION ALL 
SELECT 
	T1.ORDERS,
	T1.FISCAL_YEAR,
	T1.PERIOD,
	T1.PERIOD1,
	T1.SCENARIO,
	T1.ENTITY_CODE,
	T1.CFC_ENTITY_CODE,
	T1.AMOUNT,
	T1.CHANGES,
	CAST(CASE 
	WHEN T1.CHANGES IS NULL THEN ISNULL(T1.AMOUNT,0)
	WHEN T1.DATA_TYPE = 'SHARES' AND T2.ACC_AMOUNT <= 0 THEN 0
	ELSE T1.CHANGES*T2.ACC_AMOUNT 
	END  AS FLOAT)AS AMOUNT_CHANGES,
	CAST(CASE 
	WHEN YEAR(T1.PERIOD1) != T1.FISCAL_YEAR AND T1.CHANGES IS NULL AND T1.AMOUNT + T2.ACC_AMOUNT <= 0 THEN T2.ACC_AMOUNT * -1
	WHEN T1.CHANGES IS NULL THEN ISNULL(T1.AMOUNT,0)
	WHEN T1.DATA_TYPE = 'SHARES' AND T2.ACC_AMOUNT <= 0 THEN T2.ACC_AMOUNT * -1
	ELSE T1.CHANGES*T2.ACC_AMOUNT 
	END +ISNULL(T2.ACC_AMOUNT,0) AS FLOAT) AS ACC_AMOUNT,
	t1.DATA_TYPE,
	t1.CHINA,
	CAST(CASE 
	WHEN YEAR(T1.PERIOD1) != T1.FISCAL_YEAR AND T1.CHANGES IS NULL AND T1.AMOUNT + T2.ACC_AMOUNT <= 0 THEN 0
	WHEN T1.CHANGES IS NULL THEN ISNULL(T1.AMOUNT,0)
	WHEN T1.DATA_TYPE = 'SHARES' AND T2.ACC_AMOUNT <= 0 THEN 0
	ELSE T1.CHANGES*ISNULL(T2.ACC_AMOUNT ,0)
	END AS FLOAT )AS E2
FROM T_ORDER T1
JOIN DETAILS T2 ON T1.ORDERS = T2.ORDERS+1 AND T1.ENTITY_CODE = T2.ENTITY_CODE AND T1.CFC_ENTITY_CODE = T2.CFC_ENTITY_CODE AND T1.PERIOD = T2.PERIOD AND t1.SCENARIO = t2.SCENARIO AND t1.FISCAL_YEAR = t2.FISCAL_YEAR
)--SELECT * FROM DETAILS --WHERE TO_CHAR(PERIOD, 'YYYY-MM-DD') = '2027-12-31' AND SCENARIO = 'Per Audit' AND CFC_ENTITY_CODE = 'P00013_BVI' 
,CTE AS (
SELECT 
	ORDERS,
	FISCAL_YEAR,
	PERIOD,
	PERIOD1,
	SCENARIO,
	ENTITY_CODE,
	CFC_ENTITY_CODE,
	AMOUNT,
	CHANGES,
	AMOUNT_CHANGES,
	ACC_AMOUNT,
	DATA_TYPE,
	CHINA,
	ROUND(E2,0,1) AS E2
FROM DETAILS
WHERE FISCAL_YEAR IN (SELECT DISTINCT FISCAL_YEAR FROM TEMP_TRS_FACT_CFC_INV_INCOME2)
)--SELECT * FROM CTE
,CTE_E1 AS (
SELECT
	t1.PERIOD,
	YEAR(t1.PERIOD) AS REC_YEAR,
	t1.ENTITY_CODE,
	t1.CFC_ENTITY_CODE,
	t1.SCENARIO,
	t1.FISCAL_YEAR,
	t1.AMOUNT AS E1
FROM CTE t1
WHERE
	t1.AMOUNT > 0
)
,CTE_E5 AS (
SELECT
	PERIOD,
	FISCAL_YEAR,
	SCENARIO,
	ENTITY_CODE,
	CFC_ENTITY_CODE,
	SUM(ISNULL(ROUND(AMOUNT_CHANGES,0,1),0)) * -1 AS E5
FROM CTE 
WHERE YEAR(PERIOD) = YEAR(PERIOD1)
AND DATA_TYPE= 'SHARES'
GROUP BY PERIOD, FISCAL_YEAR, YEAR(PERIOD), SCENARIO ,ENTITY_CODE, CFC_ENTITY_CODE
), CTE_E2 AS (
SELECT 
PERIOD,
FISCAL_YEAR,
SCENARIO,
ENTITY_CODE,
CFC_ENTITY_CODE,
SUM(E2) * -1 AS E2
FROM CTE
WHERE E2 <= 0 --AND ACC_AMOUNT != 0
AND YEAR(PERIOD1)<=YEAR(PERIOD)-1
GROUP BY PERIOD,
FISCAL_YEAR,
SCENARIO,
ENTITY_CODE,
CFC_ENTITY_CODE
)
,CTE2 AS (
SELECT
	t1.PERIOD,
	t1.REC_YEAR,
	t1.ENTITY_CODE,
	t1.CFC_ENTITY_CODE,
	t1.SCENARIO,
	t1.FISCAL_YEAR,
	FLOOR(t1.E1) AS E1,
	ISNULL(t3.E2, 0) AS E2,
	ISNULL(t2.E5,0) AS E5,
	ISNULL(t4.AMOUNT,0) AS E7
FROM CTE_E1 t1
LEFT JOIN CTE_E5 t2 ON t1.PERIOD = t2.PERIOD AND t1.FISCAL_YEAR = t2.FISCAL_YEAR AND t1.SCENARIO = t2.SCENARIO AND t1.ENTITY_CODE = t2.ENTITY_CODE AND t1.CFC_ENTITY_CODE = t2.CFC_ENTITY_CODE
LEFT JOIN CTE_E2 t3 ON t1.PERIOD = t3.PERIOD AND t1.FISCAL_YEAR = t3.FISCAL_YEAR AND t1.SCENARIO = t3.SCENARIO AND t1.ENTITY_CODE = t3.ENTITY_CODE AND t1.CFC_ENTITY_CODE = t3.CFC_ENTITY_CODE
LEFT JOIN TRS_FACT_CFC_E7 t4 ON t1.PERIOD = t4.PERIOD AND t1.FISCAL_YEAR = t4.FISCAL_YEAR AND t1.SCENARIO = t4.SCENARIO AND t1.ENTITY_CODE = t4.ENTITY_CODE AND t1.CFC_ENTITY_CODE = t4.CFC_ENTITY_CODE
)
,CTE_DIVIDEND AS (
SELECT
	PERIOD,
	FISCAL_YEAR,
	SCENARIO,
	ENTITY_CODE,
	CFC_ENTITY_CODE,
	AVG_EXCHANGE_RATIO,
	L_EXCHANGE_RATE_DATE,
	SUM(NON_CHINA_DIVIDEND_PROFIT_NTD6) AS DIVIDEND6,
	SUM(NON_CHINA_PAID_TAX_NTD10) AS DIVIDEND10,
	SUM(CHINA_DIVIDEND_PROFIT_NTD7) AS DIVIDEND7,
	SUM(CHINA_PAID_TAX_NTD11) AS DIVIDEND11
FROM V_TRS_FACT_CFC_DIVIDEND
GROUP BY PERIOD, FISCAL_YEAR, SCENARIO, ENTITY_CODE, CFC_ENTITY_CODE,L_EXCHANGE_RATE_DATE, AVG_EXCHANGE_RATIO
),CTE3 AS (
SELECT
	t1.PERIOD,
	t1.REC_YEAR,
	t1.ENTITY_CODE,
	t1.CFC_ENTITY_CODE,
	t1.SCENARIO,
	t1.FISCAL_YEAR,
	t1.E1,
	t1.E2,
	ISNULL(t3.DIVIDEND6,0) - (t1.E7 * (t3.AVG_EXCHANGE_RATIO / t3.L_EXCHANGE_RATE_DATE)) AS E3,
	CASE 
    WHEN 
        (CASE WHEN t3.DIVIDEND7 < 
            (t1.E1 - E2 - (ISNULL(t3.DIVIDEND6,0) - (t1.E7 * (t3.AVG_EXCHANGE_RATIO / t3.L_EXCHANGE_RATE_DATE))) - ISNULL(t1.E5, 0)) 
         THEN t3.DIVIDEND7 
         ELSE 
            (t1.E1 - E2 - (ISNULL(t3.DIVIDEND6,0) - (t1.E7 * (t3.AVG_EXCHANGE_RATIO / t3.L_EXCHANGE_RATE_DATE))) - ISNULL(t1.E5, 0)) 
         END) > 0 
    THEN 
        (CASE WHEN t3.DIVIDEND7 < 
            (t1.E1 - E2 - (ISNULL(t3.DIVIDEND6,0) - (t1.E7 * (t3.AVG_EXCHANGE_RATIO / t3.L_EXCHANGE_RATE_DATE))) - ISNULL(t1.E5, 0)) 
         THEN t3.DIVIDEND7 
         ELSE 
            (t1.E1 - E2 - (ISNULL(t3.DIVIDEND6,0) - (t1.E7 * (t3.AVG_EXCHANGE_RATIO / t3.L_EXCHANGE_RATE_DATE))) - ISNULL(t1.E5, 0)) 
         END)
    ELSE 0 
END AS E4,
	ISNULL(t3.DIVIDEND11,0) AS DIVIDEND11,
	ISNULL(t3.DIVIDEND6,0) AS DIVIDEND6,
	ISNULL(t3.DIVIDEND7,0) AS DIVIDEND7,
	ISNULL(t3.DIVIDEND10,0) AS DIVIDEND10,
	t3.AVG_EXCHANGE_RATIO,
	t3.L_EXCHANGE_RATE_DATE AS L_EXCHANGE_RATE_DATE,
	t1.E5,
	t1.E7
FROM CTE2 t1
LEFT JOIN CTE_DIVIDEND t3 ON t1.PERIOD = t3.PERIOD AND t1.FISCAL_YEAR = t3.FISCAL_YEAR AND t1.SCENARIO = t3.SCENARIO AND t1.ENTITY_CODE = t3.ENTITY_CODE AND t1.CFC_ENTITY_CODE = t3.CFC_ENTITY_CODE
)
SELECT
	t1.PERIOD,
	t1.REC_YEAR,
	t1.ENTITY_CODE,
	t1.CFC_ENTITY_CODE,
	t1.SCENARIO,
	t1.FISCAL_YEAR,
	t1.E1,
	t1.E2,
	ISNULL(t1.E3,0) AS E3,
	ISNULL(t1.E4,0) AS E4,
	ISNULL(t1.E5,0) AS E5,
	t1.E1 - t1.E2 - ISNULL(t1.E3,0) - ISNULL(t1.E4,0) - ISNULL(t1.E5,0) AS E6,
	ISNULL(t1.E7,0) AS E7,
	ISNULL((t1.DIVIDEND7 - t1.E4) * ( t1.L_EXCHANGE_RATE_DATE/t1.AVG_EXCHANGE_RATIO ),0) AS E8,
	t1.DIVIDEND10 * (ISNULL(t1.E3,0)/AVG_EXCHANGE_RATIO) / ( (E3/AVG_EXCHANGE_RATIO) + (E7/L_EXCHANGE_RATE_DATE) ) AS E9,
	DIVIDEND11 * (ISNULL(t1.E4,0)/AVG_EXCHANGE_RATIO) / ISNULL(NULLIF( ( (E4/AVG_EXCHANGE_RATIO) + ( ((t1.DIVIDEND7 - t1.E4) * (t1.L_EXCHANGE_RATE_DATE/t1.AVG_EXCHANGE_RATIO))/L_EXCHANGE_RATE_DATE) ) , 0), 1) AS E10,
	DIVIDEND10 - t1.DIVIDEND10 * (ISNULL(t1.E3,0)/AVG_EXCHANGE_RATIO) / ( (E3/AVG_EXCHANGE_RATIO) + (E7/L_EXCHANGE_RATE_DATE) ) AS E11,
	DIVIDEND11 - DIVIDEND11 * (ISNULL(t1.E4,0)/AVG_EXCHANGE_RATIO) / ISNULL(NULLIF(( (E4/AVG_EXCHANGE_RATIO) + (t1.DIVIDEND7 - t1.E4) * (t1.AVG_EXCHANGE_RATIO / t1.L_EXCHANGE_RATE_DATE) ), 0) ,1) AS E12,
	AVG_EXCHANGE_RATIO,
	L_EXCHANGE_RATE_DATE,
	DIVIDEND6,
	DIVIDEND7
FROM CTE3 t1;






-- dbo.V_TRS_FACT_CFC_OTHER_AMOUNT source

-- dbo.V_TRS_FACT_CFC_OTHER_AMOUNT source

CREATE VIEW V_TRS_FACT_CFC_OTHER_AMOUNT AS 
WITH CTE AS (
SELECT DISTINCT
	CONCAT(T1.PERIOD, '-', RIGHT('0'+ T1.MONTH, 2)) AS PERIOD1,
	T1.ENTITY_CODE,
	T1.SCENARIO,
	T1.CURRENCY_CODE,
	T2.AVG_EXCHANGE_RATIO
FROM TRS_FACT_TRIAL_BALANCE T1
LEFT JOIN V_TRS_FACT_EXCHANGE_BANKOFTW T2 ON CONCAT(T1.PERIOD, '-', RIGHT('0'+ T1.MONTH, 2)) = T2.PERIOD AND T1.CURRENCY_CODE = T2.CURRENCY_ID  AND T2.TARGET_CURRENCY_ID = 'NTD' 
)
SELECT
	T1.ID,
	T1.PERIOD,
	T1.INV_ENTITY_CODE,
	T1.SCENARIO,
	T2.CURRENCY_CODE,
	T2.AVG_EXCHANGE_RATIO,
	T1.DESPITE_PROFIT AS DESPITE_PROFIT_ORI,
	T1.FVPL_AMOUNT AS FVPL_AMOUNT_ORI,
	T1.FVPL_FVCHANGE AS FVPL_FVCHANGE_ORI,
	T1.RE_FVPL_AMOUNT AS RE_FVPL_AMOUNT_ORI,
	T1.DESPITE_PROFIT * AVG_EXCHANGE_RATIO AS DESPITE_PROFIT,
	T1.FVPL_AMOUNT * AVG_EXCHANGE_RATIO AS FVPL_AMOUNT,
	T1.FVPL_FVCHANGE * AVG_EXCHANGE_RATIO AS FVPL_FVCHANGE,
	T1.RE_FVPL_AMOUNT * AVG_EXCHANGE_RATIO AS RE_FVPL_AMOUNT,
	T1.CREATED_TIME,
	T1.CREATED_BY
FROM TRS_FACT_CFC_OTHER_AMOUNT T1
LEFT JOIN CTE T2 ON FORMAT(T1.PERIOD, 'yyyy-MM') = T2.PERIOD1 AND T1.INV_ENTITY_CODE = T2.ENTITY_CODE AND T1.SCENARIO = T2.SCENARIO;

-- dbo.V_TRS_FACT_CFC_RECOGNIZED_LOSS source

CREATE view V_TRS_FACT_CFC_RECOGNIZED_LOSS ("ID", "PERIOD", "CFC_ENTITY_CODE", "SCENARIO", "TYPE", "DECLARE_DATE", "REC_YEAR", "CURRENCY", "REDUC_RATIO", "AMOUNT_ORI", "EXCHANGE_RATIO", "AMOUNT") AS 
  WITH CTE_PERIOD AS (
SELECT
	PERIOD,
	SCENARIO,
	ENTITY_CODE
FROM V_TRS_FACT_CFC_ENTITY_VERSION
),RECOGNIZED_LOSS AS(
SELECT
t1.ID,
t2.CURRENT_CODE AS CFC_ENTITY_CODE, --用CURRENT_CODE輸出
t1.SCENARIO ,
t1."TYPE" ,
t1.DECLARE_DATE ,
t1.REC_YEAR ,
t1.REDUC_RATIO ,
t1.AMOUNT ,
t2.country_id
FROM TRS_FACT_CFC_RECOGNIZED_LOSS t1
LEFT JOIN V_TRS_DIM_ENTITY_CUR  t2 ON t1.CFC_ENTITY_CODE = t2.ENTITY_CODE 
)
SELECT
t1.ID,
t0.PERIOD,
t1.CFC_ENTITY_CODE,
t1.scenario,
t1.type,
t1.DECLARE_DATE,
t1.REC_YEAR,
t3.DEFAULT_CURRENCY_ID as CURRENCY,
t1.REDUC_RATIO,
t1.AMOUNT as AMOUNT_ORI,
t4.AVG_EXCHANGE_RATIO as EXCHANGE_RATIO,
t4.AVG_EXCHANGE_RATIO * isnull(t1.AMOUNT,0) as AMOUNT
FROM CTE_PERIOD t0
JOIN RECOGNIZED_LOSS t1 ON t1.DECLARE_DATE BETWEEN DATEFROMPARTS (year(t0.PERIOD), 1,1) AND t0.PERIOD AND t0.ENTITY_CODE = t1.CFC_ENTITY_CODE AND t0.SCENARIO = t1.SCENARIO
--LEFT JOIN V_TRS_DIM_ENTITY_CUR t2 ON t1.CFC_ENTITY_CODE = t2.ENTITY_CODE --AND t2.ENTITY_TYPE_ID = '003'
LEFT JOIN (SELECT DISTINCT country_id,DEFAULT_CURRENCY_ID FROM V_TRS_DIM_COUNTRY) t3 on t1.COUNTRY_ID = t3.COUNTRY_ID 
left join V_TRS_FACT_EXCHANGE_BANKOFTW t4 on t3.DEFAULT_CURRENCY_ID = t4.CURRENCY_ID and t1.scenario = t4.scenario AND t4.TARGET_CURRENCY_ID = 'NTD' AND t0.PERIOD = t4.PERIOD_DATE;


-- dbo.V_TRS_FACT_CFC_RESTRICTED_DISTRIBUTION source

-- dbo.V_TRS_FACT_CFC_RESTRICTED_DISTRIBUTION source

-- dbo.V_TRS_FACT_CFC_RESTRICTED_DISTRIBUTION source

CREATE VIEW V_TRS_FACT_CFC_RESTRICTED_DISTRIBUTION("ID", "PERIOD", "ENTITY_CODE", "SCENARIO", "ITEM_PERIOD", "ITEM", "ORIGIN_YEAR", "AMOUNT_ORI", "CREATED_TIME", "CURRENCY_ID", "AVG_EXCHANGE_RATIO", "AMOUNT") AS 
  WITH T AS(
SELECT 
ID,
CURRENT_CODE AS CFC_ENTITY_CODE,
SCENARIO,
ITEM_PERIOD,
ITEM,
ORIGIN_YEAR,
AMOUNT,
CREATED_TIME,
t1.CURRENCY_ID
FROM TRS_FACT_CFC_RESTRICTED_DISTRIBUTION t1
LEFT JOIN V_TRS_DIM_ENTITY_CUR t2 ON t1.CFC_ENTITY_CODE = t2.ENTITY_CODE
)  
SELECT
	t2.ID,
	t1.PERIOD,
	t1.ENTITY_CODE,
--	t2.CFC_ENTITY_CODE,
	t2.SCENARIO,
	t2.ITEM_PERIOD,
	t2.ITEM,
	t2.ORIGIN_YEAR,
	t2.AMOUNT AS AMOUNT_ORI,
	t2.CREATED_TIME,
	t2.CURRENCY_ID,
	t4.AVG_EXCHANGE_RATIO,
	FLOOR(t2.AMOUNT * t4.AVG_EXCHANGE_RATIO) AS AMOUNT
FROM V_TRS_FACT_CFC_ENTITY_VERSION t1
JOIN T t2 ON t2.CFC_ENTITY_CODE = t1.ENTITY_CODE AND t1.SCENARIO = t2.SCENARIO
AND t2.ITEM_PERIOD BETWEEN DATEFROMPARTS(YEAR(t1.PERIOD), 1, 1) AND t1.PERIOD
LEFT JOIN V_TRS_FACT_EXCHANGE_BANKOFTW t4 ON t2.CURRENCY_ID = t4.CURRENCY_ID AND t4.TARGET_CURRENCY_ID = 'NTD' AND t2.SCENARIO = t4.SCENARIO AND format(t1.PERIOD, 'yyyy-MM') = t4.PERIOD
UNION ALL
  (SELECT
	t2.ID,
	t1.PERIOD,
	t1.ENTITY_CODE,
--	t2.CFC_ENTITY_CODE,
	t2.SCENARIO,
	t2.ITEM_PERIOD,
	t2.ITEM,
	t2.ORIGIN_YEAR,
	t2.AMOUNT AS AMOUNT_ORI,
	t2.CREATED_TIME,
	t2.CURRENCY_ID,
	t4.AVG_EXCHANGE_RATIO,
	FLOOR(t2.AMOUNT * t4.AVG_EXCHANGE_RATIO) AS AMOUNT
FROM V_TRS_FACT_CFC_ENTITY_VERSION t1
JOIN T t2 ON t2.CFC_ENTITY_CODE = t1.ENTITY_CODE AND t1.SCENARIO = t2.SCENARIO
AND YEAR(t2.ITEM_PERIOD) = YEAR(t1.PERIOD)+1
LEFT JOIN V_TRS_FACT_EXCHANGE_BANKOFTW t4 ON t2.CURRENCY_ID = t4.CURRENCY_ID AND t4.TARGET_CURRENCY_ID = 'NTD' AND t2.SCENARIO = t4.SCENARIO AND format(t1.PERIOD, 'yyyy-MM') = t4.PERIOD
AND format(t1.period,'MM')='12');





-- dbo.V_TRS_FACT_CFC_TAX_INCOME_TOTAL source

CREATE VIEW V_TRS_FACT_CFC_TAX_INCOME_TOTAL AS
WITH CTE_THIS_YEAR AS(
SELECT
	SUM(DEDUCTION) AS DEDUCTION,
	SCENARIO,
	ENTITY_CODE,
	CFC_ENTITY_CODE,
	PERIOD,
	FISCAL_YEAR
FROM V_TRS_CFC_10Y_DEDUCTION_DETAIL
WHERE CATEGORY = '0' AND YEAR(PERIOD) = YEAR(DEDUCTED_YEAR)
GROUP BY PERIOD, SCENARIO, ENTITY_CODE, CFC_ENTITY_CODE, FISCAL_YEAR
), CTE_LIMIT AS (
--	自”限制分配狀況”頁面取數，加總金額；若該CFC為實質營運，則顯示空白
	SELECT
		t1.PERIOD,
		t1.SCENARIO,
		t1.ENTITY_CODE AS CFC_ENTITY_CODE,
		SUM(t1.AMOUNT) AS LIMIT_ITEMS
	FROM V_TRS_FACT_CFC_RESTRICTED_DISTRIBUTION t1
	WHERE 1 = 1
		AND ITEM != 'SPECIAL_RESERVE_NREGU'
		AND YEAR(t1.PERIOD) = t1.ORIGIN_YEAR
	GROUP BY t1.PERIOD, t1.SCENARIO, t1.ENTITY_CODE
)
SELECT
	t1.ENTITY_CODE,
	t1.INV_ENTITY_CODE,
	t1.PERIOD,
	t1.SCENARIO,
	t1.SUB_OPE_EXEMPTION,
	t1.COUNTRY_ID,
	t1.LOCAL_CURRENCY_ID,
	t1.ACCUMULATED_AMOUNT,
	t1.AMOUNT_TOTAL,
	t1.REALIZED_LOSS,
	t1.DISTRI_NONCN,
	t1.DISTRI_CN,
	t2.LIMIT_ITEMS,
	t1.FVPL_FVCHANGE,
	t1.DESPITE_PROFIT,
	t1.FVPL_AMOUNT,
	t1.RE_FVPL_AMOUNT,
	t1.NON_CFC_DISPOSAL_ADJ,
	FLOOR(t1.CFC_EARNINGS - ISNULL(t4.DEDUCTION, 0) - ISNULL(t2.LIMIT_ITEMS, 0)) AS TAX_INC_BEFORE_RATIO,
	t1.AVG_RATIO_HOLD AS RATIO_HOLD,
	FLOOR((t1.CFC_EARNINGS - ISNULL(t4.DEDUCTION, 0) - ISNULL(t2.LIMIT_ITEMS, 0)) * t1.AVG_RATIO_HOLD)AS TAX_INC,
	t4.DEDUCTION,
	t1.CFC_EARNINGS,
	t1.FVPL_APP
FROM V_TRS_FACT_CFC_TAX_INCOME t1
LEFT JOIN CTE_THIS_YEAR t4 ON t4.PERIOD = t1.PERIOD AND t1.SCENARIO = t4.SCENARIO AND t1.ENTITY_CODE = t4.ENTITY_CODE AND t1.INV_ENTITY_CODE = t4.CFC_ENTITY_CODE
LEFT JOIN CTE_LIMIT T2 ON T1.SCENARIO = T2.SCENARIO AND T1.INV_ENTITY_CODE = T2.CFC_ENTITY_CODE AND T1.PERIOD = T2.PERIOD;




-- dbo.V_TRS_FACT_CURRENCY source

CREATE   VIEW V_TRS_FACT_CURRENCY([CURRENCY_FACT_ID], [CURRENCY_ID], [TARGET_CURRENCY_ID], [EXCHANGE_RATIO], [PERIOD], [CREATED_BY], [CREATED_TIME], [UPDATED_BY], [UPDATED_TIME]) AS 
  SELECT 
CURRENCY_FACT_ID ,
CURRENCY_ID ,
TARGET_CURRENCY_ID ,
EXCHANGE_RATIO ,
PERIOD,
CREATED_BY ,
CREATED_TIME ,
UPDATED_BY ,
UPDATED_TIME 
FROM trs_fact_currency
UNION ALL
SELECT DISTINCT
'dummy' AS CURRENCY_FACT_ID,
CURRENCY_ID ,
CAST(CURRENCY_ID AS NVARCHAR(255)) AS TARGET_CURRENCY_ID ,
1 AS EXCHANGE_RATIO ,
PERIOD,
CAST('dummy'AS NVARCHAR(255)) AS CREATED_BY ,
CAST(GETDATE() AS DATETIME) AS CREATED_TIME ,
CAST('dummy'AS NVARCHAR(255)) AS UPDATED_BY ,
CAST(GETDATE() AS DATETIME) AS UPDATED_TIME 
FROM trs_fact_currency
;