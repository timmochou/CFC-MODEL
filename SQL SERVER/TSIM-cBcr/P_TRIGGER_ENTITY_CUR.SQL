CREATE PROCEDURE P_TRIGGER_ENTITY_CUR AS
BEGIN
SELECT GETDATE() AS UPDATE_TIME;
TRUNCATE TABLE V_TRS_DIM_ENTITY_CUR;
WITH CTE AS (
    -- 基礎查詢，從 IS_ACTIVE = 'true' 的節點開始
    SELECT 
        ENTITY_CODE,
        ENTITY_CODE AS current_code,
        COUNTRY_ID,
        CURRENCY_ID,
        IS_ACTIVE,
        IS_ACTIVE AS SHOW,
        ENTITY_TYPE_ID,
        PRE_CODE
    FROM TRS_DIM_ENTITY 
    WHERE IS_ACTIVE = 'true'
    UNION ALL
    -- 遞迴部分，尋找子節點
    SELECT 
        t.ENTITY_CODE,
        c.current_code, -- 保持遞迴開始的起點 ENTITY_CODE 不變
        t.COUNTRY_ID,
        t.CURRENCY_ID,
        t.IS_ACTIVE,
        t.IS_ACTIVE AS SHOW,
        t.ENTITY_TYPE_ID,
        t.PRE_CODE
    FROM TRS_DIM_ENTITY t
    JOIN CTE c ON c.PRE_CODE = t.ENTITY_CODE
    WHERE c.pre_code IS NOT NULL AND t.IS_ACTIVE ='false'
),CTE_RES AS (
SELECT 
    ENTITY_CODE,
    current_code,
    COUNTRY_ID,
    CURRENCY_ID,
    IS_ACTIVE,
    SHOW,
    ENTITY_TYPE_ID
FROM CTE
UNION ALL
SELECT
t1.ENTITY_CODE,
t1.ENTITY_CODE AS CURRENT_CODE,
t1.COUNTRY_ID,
t1.CURRENCY_ID,
t1.IS_ACTIVE,
'true' AS SHOW,
t1.ENTITY_TYPE_ID
FROM TRS_DIM_ENTITY t1
LEFT JOIN TRS_DIM_ENTITY t2 ON t2.PRE_CODE =t1.ENTITY_CODE
WHERE t1.IS_ACTIVE = 'false' AND t2.PRE_CODE IS NULL
UNION ALL 
--加入權益法公司
SELECT 
ENTITY_CODE,
ENTITY_CODE AS CURRENT_CODE,
CAST(COUNTRY_CODE AS VARCHAR(36)) AS COUNTRY_ID, 
LOCAL_CURRENCY AS CURRENCY_ID,
'true' AS IS_ACTIVE,
'true' AS SHOW,
'003' AS ENTITY_TYPE_ID
FROM TRS_DIM_EQUITY_INV_LIST)
INSERT INTO V_TRS_DIM_ENTITY_CUR
SELECT * FROM CTE_RES
END;