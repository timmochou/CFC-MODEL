WITH COUNTRY AS (SELECT 
    T1.PERIOD,
    T4.COUNTRY_ID AS ID1,
    T4.COUNTRY_NAME AS NAME,
    T1.DATA_NAME,
    SUM(TRY_CAST(T1.VALUE AS DECIMAL(38,2))) AS VALUE  
FROM 
    [dbo].[TRS_FACT_COUNTRY_REPORT] T1
LEFT JOIN
    TRSDB.dbo.V_TRS_DIM_ENTITY_CUR T2
ON T1.ENTITY_ID = T2.ENTITY_CODE 
LEFT JOIN 
    V_TRS_DIM_ENTITY T3
ON T1.ENTITY_ID = T3.ENTITY_ID AND T3.FR_LOCALE='en_US'
LEFT JOIN 
    V_TRS_DIM_COUNTRY T4
ON T3.COUNTRY_ID = T4.COUNTRY_ID AND T4.FR_LOCALE='en_US'
WHERE
1=1
AND
T1.REPORT_NAME = 'report1'
AND T3.FR_LOCALE='en_US'
AND T1.DATA_NAME = '${P_CATEGORY3}'
AND T1.PERIOD = '${P_PERIOD}'
${if(len(P_COUNTRY) == 0,"","and T3.COUNTRY_ID IN ('" + P_COUNTRY + "')")}
GROUP BY 
T1.PERIOD,
    T4.COUNTRY_ID,
    T4.COUNTRY_NAME,
    T1.DATA_NAME
), COMPANY AS (
    SELECT 
    --T1.ID,
    T1.PERIOD,
    T1.ENTITY_ID AS ID1,
    T3.ENTITY_NAME AS NAME,
    T1.DATA_NAME,
    SUM(TRY_CAST(T1.VALUE AS DECIMAL(38,2))) AS VALUE  
FROM 
    [dbo].[TRS_FACT_COUNTRY_REPORT] T1
LEFT JOIN
    TRSDB.dbo.V_TRS_DIM_ENTITY_CUR T2
ON T1.ENTITY_ID = T2.ENTITY_CODE 
LEFT JOIN 
    V_TRS_DIM_ENTITY T3
ON T1.ENTITY_ID = T3.ENTITY_ID
AND T3.FR_LOCALE='en_US'
WHERE
1=1 
AND 
T1.REPORT_NAME = 'report1'
AND T1.DATA_NAME = '${P_CATEGORY3}'
AND T1.PERIOD = '${P_PERIOD}'
${if(len(P_COMPANY) == 0,"","and T1.ENTITY_ID IN ('" + P_COMPANY + "')")}
${if(len(P_COUNTRY) == 0,"","and T3.COUNTRY_ID IN ('" + P_COUNTRY + "')")}
GROUP BY
--T1.ID,
    T1.PERIOD,
    T1.ENTITY_ID,
    T3.ENTITY_NAME,
    T1.DATA_NAME
)
SELECT 
--ID,
PERIOD,
ID1,
NAME,
DATA_NAME,
VALUE,
SUM(VALUE)/SUM(VALUE) OVER() AS PERCENTAGE
FROM
${if(BTN_TYPE == '1' , "COMPANY",if(BTN_TYPE == '2',"COMPANY" ,"COUNTRY"))}
WHERE ID1 IS NOT NULL
GROUP BY PERIOD, ID1, NAME, DATA_NAME, VALUE
ORDER BY VALUE DESC