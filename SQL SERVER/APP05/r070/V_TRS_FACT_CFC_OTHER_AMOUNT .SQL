-- dbo.V_TRS_FACT_CFC_OTHER_AMOUNT source

-- dbo.V_TRS_FACT_CFC_OTHER_AMOUNT source

CREATE VIEW V_TRS_FACT_CFC_OTHER_AMOUNT AS 
WITH CTE AS (
SELECT DISTINCT
	CONCAT(T1.PERIOD, '-', RIGHT('0'+ T1.MONTH, 2)) AS PERIOD1,
	T1.ENTITY_CODE,
	T1.SCENARIO,
	T1.CURRENCY_CODE,
	T2.AVG_EXCHANGE_RATIO
FROM TRS_FACT_TRIAL_BALANCE T1
LEFT JOIN V_TRS_FACT_EXCHANGE_BANKOFTW T2 ON CONCAT(T1.PERIOD, '-', RIGHT('0'+ T1.MONTH, 2)) = T2.PERIOD AND T1.CURRENCY_CODE = T2.CURRENCY_ID  AND T2.TARGET_CURRENCY_ID = 'NTD' 
)
SELECT
	T1.ID,
	T1.PERIOD,
	T1.INV_ENTITY_CODE,
	T1.SCENARIO,
	T2.CURRENCY_CODE,
	T2.AVG_EXCHANGE_RATIO,
	T1.DESPITE_PROFIT AS DESPITE_PROFIT_ORI,
	T1.FVPL_AMOUNT AS FVPL_AMOUNT_ORI,
	T1.FVPL_FVCHANGE AS FVPL_FVCHANGE_ORI,
	T1.RE_FVPL_AMOUNT AS RE_FVPL_AMOUNT_ORI,
	T1.DESPITE_PROFIT * AVG_EXCHANGE_RATIO AS DESPITE_PROFIT,
	T1.FVPL_AMOUNT * AVG_EXCHANGE_RATIO AS FVPL_AMOUNT,
	T1.FVPL_FVCHANGE * AVG_EXCHANGE_RATIO AS FVPL_FVCHANGE,
	T1.RE_FVPL_AMOUNT * AVG_EXCHANGE_RATIO AS RE_FVPL_AMOUNT,
	T1.CREATED_TIME,
	T1.CREATED_BY
FROM TRS_FACT_CFC_OTHER_AMOUNT T1
LEFT JOIN CTE T2 ON FORMAT(T1.PERIOD, 'yyyy-MM') = T2.PERIOD1 AND T1.INV_ENTITY_CODE = T2.ENTITY_CODE AND T1.SCENARIO = T2.SCENARIO;