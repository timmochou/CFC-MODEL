CREATE PROCEDURE P_INV_CONTROL_LOOP_DATE
AS
BEGIN
	SELECT GETDATE() AS UPDATE_TIME;
    DECLARE @P_DATE DATE = EOMONTH('2022-01-01'); -- 設定起始日
    DECLARE @P_DATE_DIF INT = DATEDIFF(MONTH, EOMONTH('2022-01-01'), GETDATE()); 
    -- 計算起始日與目前日期的月份差

    -- 清空目標表
    CREATE TABLE TEMP_TRS_FACT_INV_CONTROL(
	ID varchar(36) COLLATE Chinese_Taiwan_Stroke_CI_AS NOT NULL,
	PERIOD date NULL,
	ENTITY_CODE nvarchar(255) COLLATE Chinese_Taiwan_Stroke_CI_AS NULL,
	INV_ENTITY_CODE nvarchar(255) COLLATE Chinese_Taiwan_Stroke_CI_AS NULL,
	UPDATED_TIME datetime NULL,
	RATIO_SUM decimal(24,5) NULL,
	RATIO_DIRECT decimal(24,5) NULL,
	RATIO_INDIRECT decimal(24,5) NULL,
);
	
	
    DECLARE @i INT = 1;
    WHILE @i <= @P_DATE_DIF + 48
    BEGIN
        -- 查詢符合日期範圍的 ENTITY_CODE
        DECLARE CUR CURSOR FOR
        SELECT DISTINCT ENTITY_CODE 
        FROM TRS_FACT_GROUP_INV_REL
        WHERE START_DATE <= @P_DATE AND END_DATE >= @P_DATE
        ORDER BY ENTITY_CODE;

        OPEN CUR;
        DECLARE @ENTITY_CODE VARCHAR(255);

        FETCH NEXT FROM CUR INTO @ENTITY_CODE;
        WHILE @@FETCH_STATUS = 0
        BEGIN
            -- 執行計算控制力的存儲程序
            EXEC P_CALCULATE_INV_CONTROL @ENTITY_CODE, @P_DATE;
            FETCH NEXT FROM CUR INTO @ENTITY_CODE;
        END;
        CLOSE CUR;
        DEALLOCATE CUR;

        -- 更新 TRS_FACT_INV_CONTROL 表的 PERIOD 欄位為 P_DATE
        UPDATE TEMP_TRS_FACT_INV_CONTROL
        SET PERIOD = @P_DATE
        WHERE PERIOD IS NULL;

        -- 計算下一個月的最後一天
        SET @P_DATE = EOMONTH(DATEADD(MONTH, 1, @P_DATE));
        SET @i = @i + 1;
    END;

    -- 計算間接持股比率，更新最後編輯時間
    UPDATE TEMP_TRS_FACT_INV_CONTROL
    SET RATIO_INDIRECT = RATIO_SUM - RATIO_DIRECT,
        UPDATED_TIME = GETDATE();
  TRUNCATE TABLE TRS_FACT_INV_CONTROL;
  INSERT INTO TRS_FACT_INV_CONTROL(ID,PERIOD, ENTITY_CODE, INV_ENTITY_CODE,UPDATED_TIME, RATIO_SUM, RATIO_DIRECT,RATIO_INDIRECT)
  SELECT * FROM TEMP_TRS_FACT_INV_CONTROL;
  DROP TABLE TEMP_TRS_FACT_INV_CONTROL;
END;